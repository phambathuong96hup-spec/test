<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c - Pro (AI Integrated)</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Libraries -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- CSS G·ªêC --- */
        :root {
            --primary-color: #0f9d58;
            --secondary-color: #e8f5e9;
            --text-dark: #2c3e50;
            --bg-body: #f8f9fa;
            --card-radius: 16px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .header-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .nav-pills {
            background: #f1f3f4;
            padding: 5px;
            border-radius: 12px;
            display: inline-flex;
            width: 100%;
        }

        .nav-pills .nav-item { flex: 1; }

        .nav-pills .nav-link {
            color: #5f6368;
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 15px;
            transition: var(--transition);
        }

        .nav-pills .nav-link.active {
            background-color: white;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .nav-pills .nav-link:hover:not(.active) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .card-custom {
            border: none;
            border-radius: var(--card-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
            overflow: hidden;
        }

        .card-custom:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }

        .card-header-custom {
            background: var(--secondary-color);
            padding: 15px 20px;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid rgba(15, 157, 88, 0.1);
        }

        .table-custom thead th {
            background-color: #f1f3f4;
            color: #444;
            font-weight: 600;
            border: none;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 12px;
        }

        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover { background-color: #f8fff9; }

        .badge-status {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .bg-todo { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .bg-doing { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
        .bg-done { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .bg-overdue { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .bg-waiting { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }

        .badge-diff {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid transparent;
            margin-right: 4px;
        }

        .diff-easy { color: #198754; background: #d1e7dd; border-color: #a3cfbb; }
        .diff-medium { color: #fd7e14; background: #ffe5d0; border-color: #fecba1; }
        .diff-hard { color: #dc3545; background: #f8d7da; border-color: #f5c2c7; }
        .diff-complex { color: #6610f2; background: #e0cffc; border-color: #bda5f9; }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 10px 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(15, 157, 88, 0.25);
        }

        #calendar {
            background: white;
            padding: 15px;
            border-radius: var(--card-radius);
        }

        .fc-event {
            border: none !important;
            border-radius: 4px !important;
            padding: 2px 4px !important;
            font-size: 0.8rem !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .fc-day-today { background-color: #f0fdf4 !important; }

        .fc-toolbar-title {
            font-size: 1.2rem !important;
            font-weight: 700;
            color: var(--primary-color);
        }

        .fc-button-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .admin-only, .logged-only { display: none !important; }
        .deadline-extended { color: #6f42c1; font-weight: 700; }
        .deadline-original { text-decoration: line-through; color: #aaa; font-size: 0.8em; }

        .person-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .person-item:hover { background-color: #f5f5f5; }
        .person-item input { margin-right: 10px; transform: scale(1.1); }
        .dropdown-menu-custom { max-height: 250px; overflow-y: auto; padding: 0; }
        .btn-action-group .btn { margin-right: 4px; margin-bottom: 4px; }

        /* --- CHATBOT UI --- */
        .chat-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px;
            border-radius: 50%; background: linear-gradient(135deg, #0f9d58, #0b7a43);
            color: white; border: none; font-size: 28px;
            box-shadow: 0 4px 15px rgba(15, 157, 88, 0.4); z-index: 1000;
            transition: transform 0.3s; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .chat-btn:hover { transform: scale(1.1); }
        
        .chat-box {
            position: fixed; bottom: 100px; right: 30px;
            width: 360px; height: 500px;
            background: white; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none; flex-direction: column; z-index: 1000;
            overflow: hidden; border: 1px solid #eee;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-header { 
            background: linear-gradient(135deg, #0f9d58, #0b7a43); 
            color: white; padding: 15px 20px; 
            font-weight: 700; display: flex; justify-content: space-between; align-items: center; 
        }
        .chat-body { 
            flex: 1; padding: 15px; overflow-y: auto; 
            background: #f9f9f9; font-size: 0.9rem; scroll-behavior: smooth;
        }
        .chat-footer { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white; }
        
        .msg { margin-bottom: 12px; padding: 10px 14px; border-radius: 12px; max-width: 85%; line-height: 1.4; word-wrap: break-word; }
        .msg-user { background: #d1e7dd; color: #0f5132; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-ai { background: white; border: 1px solid #e0e0e0; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .typing { font-style: italic; color: #888; font-size: 0.8rem; margin-bottom: 10px; display: none; margin-left: 10px; }
        
        @media (max-width: 576px) {
            .chat-box { width: 90%; right: 5%; bottom: 90px; height: 60vh; }
        }
    </style>
</head>
<body>

<div class="container-xxl py-3">
    <!-- Header -->
    <div class="header-section d-flex flex-wrap justify-content-between align-items-center">
        <div class="d-flex align-items-center mb-2 mb-md-0">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; font-size: 24px;">üè•</div>
            <div>
                <h4 class="fw-bold m-0" style="color: var(--primary-color);">KHOA D∆Ø·ª¢C</h4>
                <small class="text-muted">H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác & AI Lily</small>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span id="userDisplay" class="fw-bold text-dark bg-light px-3 py-2 rounded-pill border"></span>
            <button class="btn btn-outline-secondary btn-sm d-none" id="btnChangePin" onclick="showChangePinModal()">üîê ƒê·ªïi PIN</button>
            <button class="btn btn-primary btn-sm px-3 rounded-pill fw-bold" id="btnLogin" onclick="showLoginModal()">üë§ ƒêƒÉng nh·∫≠p</button>
            <button class="btn btn-outline-danger btn-sm px-3 rounded-pill d-none" id="btnLogout" onclick="logout()">üö™ Tho√°t</button>
        </div>
    </div>

    <!-- Navigation -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">
                üìã Danh s√°ch
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">
                üìä B√°o c√°o & L·ªãch
            </button>
        </li>
        <li class="nav-item admin-only" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-input">
                üìù Giao vi·ªác
            </button>
        </li>
        <li class="nav-item admin-only" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-compliance">
                ‚öñÔ∏è N·ªôi quy
            </button>
        </li>
    </ul>

    <!-- Content -->
    <div class="tab-content" id="pills-tabContent">
        
        <!-- TAB 1: DANH S√ÅCH -->
        <div class="tab-pane fade show active" id="pills-list">
            <div class="card card-custom p-3 mb-3">
                <div class="row g-2 align-items-center">
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">B·ªô ph·∫≠n</label>
                        <select id="filterGroup" class="form-select form-select-sm" onchange="renderTable()"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">Nh√¢n s·ª±</label>
                        <select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">ƒê·ªô kh√≥</label>
                        <select id="filterDifficulty" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="1">‚≠ê D·ªÖ</option>
                            <option value="2">‚≠ê‚≠ê Trung b√¨nh</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Kh√≥</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Ph·ª©c t·∫°p</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">Tr·∫°ng th√°i</label>
                        <select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Pending">‚è≥ Ch∆∞a ho√†n th√†nh</option>
                            <option value="Waiting">‚úã Ch·ªù duy·ªát</option>
                            <option value="Done">‚úÖ ƒê√£ ho√†n th√†nh</option>
                            <option value="Overdue">üî• Qu√° h·∫°n</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">T√¨m ki·∫øm</label>
                        <input type="text" id="filterText" class="form-control form-control-sm" placeholder="T√™n c√¥ng vi·ªác..." onkeyup="renderTable()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-1">
                        <button class="btn btn-warning btn-sm w-100 fw-bold text-dark admin-only" onclick="triggerBulkEmail()" title="G·ª≠i mail nh·∫Øc vi·ªác ch∆∞a xong">üì® Nh·∫Øc All</button>
                        <button class="btn btn-light border btn-sm" onclick="loadTaskList()" title="T·∫£i l·∫°i"><span style="font-size: 1.2em;">üîÑ</span></button>
                    </div>
                </div>
            </div>
            <div class="card card-custom">
                <div class="table-responsive">
                    <table class="table table-hover table-custom mb-0">
                        <thead>
                            <tr>
                                <th width="30%">C√¥ng vi·ªác / T·ªï</th>
                                <th width="10%" class="text-center">ƒê·ªô kh√≥</th>
                                <th width="15%">Ti·∫øn ƒë·ªô</th>
                                <th width="15%">Ng∆∞·ªùi th·ª±c hi·ªán</th>
                                <th width="12%">Deadline</th>
                                <th width="10%">Tr·∫°ng th√°i</th>
                                <th width="8%" class="text-center">T√°c v·ª•</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 2: B√ÅO C√ÅO -->
        <div class="tab-pane fade" id="pills-report">
            <div class="card card-custom p-3 mb-4 bg-white border-start border-5 border-success">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold text-success fs-5">üìÖ B√ÅO C√ÅO TH√ÅNG:</span>
                        <input type="month" id="reportMonthSelect" class="form-control form-control-lg" style="width: auto;" onchange="updateReport()">
                    </div>
                    <button class="btn btn-success fw-bold shadow-sm px-4" onclick="exportExcelReport()">üì• Xu·∫•t Excel</button>
                </div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card card-custom h-100">
                        <div class="card-header-custom text-center">üìä T√¨nh tr·∫°ng chung</div>
                        <div class="card-body p-0 d-flex justify-content-center align-items-center">
                            <div id="piechart_task" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-3">
                    <div class="card card-custom h-100">
                        <div class="card-header-custom text-center">üß© Ph√¢n b·ªë ƒê·ªô kh√≥</div>
                        <div class="card-body p-0 d-flex justify-content-center align-items-center">
                            <div id="piechart_difficulty" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 col-lg-6">
                    <div class="card card-custom h-100">
                        <div class="card-header-custom text-center">üìà Chi ti·∫øt nh√¢n s·ª±</div>
                        <div class="card-body p-0">
                            <div id="barchart_task" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-6">
                    <div class="card card-custom h-100 border-start border-4 border-danger">
                        <div class="p-2 text-center text-danger fw-bold bg-light">‚ö†Ô∏è Vi ph·∫°m</div>
                        <div class="card-body p-0">
                            <div id="columnchart_violation" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom h-100 border-start border-4 border-warning">
                        <div class="p-2 text-center text-warning fw-bold bg-light">üèÜ Khen th∆∞·ªüng</div>
                        <div class="card-body p-0">
                            <div id="columnchart_reward" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card card-custom p-1">
                <div class="card-header-custom bg-white text-dark d-flex justify-content-between align-items-center">
                    <span>üìÖ L·ªäCH C√îNG T√ÅC & DEADLINE</span>
                    <div class="d-flex gap-2 small">
                        <span class="badge bg-success">ƒê√£ xong</span>
                        <span class="badge bg-danger">Qu√° h·∫°n</span>
                        <span class="badge bg-primary">S·∫Øp t·ªõi</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- TAB 3: GIAO VI·ªÜC -->
        <div class="tab-pane fade" id="pills-input">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card card-custom">
                        <div class="card-header-custom">üìù TH√äM C√îNG VI·ªÜC M·ªöI</div>
                        <div class="card-body p-4">
                            <form id="taskForm">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">T√™n c√¥ng vi·ªác <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="taskName" required placeholder="Nh·∫≠p t√™n ƒë·∫ßu vi·ªác...">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                                    <select name="assignee" id="hiddenAssigneeSelect" multiple style="display:none"></select>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center bg-white py-2" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                            <span id="selectedText" class="text-dark">-- Ch·ªçn nh√¢n s·ª± --</span>
                                            <span class="badge bg-success rounded-pill" id="selectedCount">0</span>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-custom shadow w-100" id="checkboxContainer"></div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Thu·ªôc T·ªï/B·ªô ph·∫≠n</label>
                                        <select class="form-select" name="group" id="groupSelect"></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Ph√¢n lo·∫°i</label>
                                        <select class="form-select" name="taskType" id="taskTypeSelect" onchange="toggleDeadline()">
                                            <option value="Th∆∞·ªùng quy" selected>üü¶ Th∆∞·ªùng quy (Kh√¥ng g·∫•p)</option>
                                            <option value="C√≥ h·∫°n">üü• C√≥ Deadline (Quan tr·ªçng)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">M·ª©c ƒë·ªô ∆Øu ti√™n</label>
                                        <select class="form-select" name="priority">
                                            <option value="P1">üî¥ Cao (Kh·∫©n c·∫•p)</option>
                                            <option value="P2" selected>üü° Trung b√¨nh</option>
                                            <option value="P3">üü¢ Th·∫•p</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">ƒê·ªô kh√≥</label>
                                        <select class="form-select" name="difficulty">
                                            <option value="1">‚≠ê D·ªÖ</option>
                                            <option value="2" selected>‚≠ê‚≠ê Trung b√¨nh</option>
                                            <option value="3">‚≠ê‚≠ê‚≠ê Kh√≥</option>
                                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Ph·ª©c t·∫°p</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">H·∫°n ch√≥t (Deadline)</label>
                                        <input type="date" class="form-control" name="deadline" id="deadlineInput">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Ghi ch√∫ / M√¥ t·∫£</label>
                                    <textarea class="form-control" name="notes" rows="3" placeholder="Chi ti·∫øt y√™u c·∫ßu..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="submitBtn">üíæ L∆ØU C√îNG VI·ªÜC</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: N·ªòI QUY -->
        <div class="tab-pane fade" id="pills-compliance">
             <div class="row g-4">
                <div class="col-md-4">
                    <div class="card card-custom h-100 border-0">
                        <div class="card-header bg-danger text-white fw-bold text-center">‚öñÔ∏è Ghi nh·∫≠n Vi ph·∫°m/Khen</div>
                        <div class="card-body">
                            <form id="complianceForm">
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Nh√¢n vi√™n</label>
                                    <select class="form-select" name="person" id="compliancePerson" required></select>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Lo·∫°i h√¨nh</label>
                                    <select class="form-select" name="type" required>
                                        <option value="Vi ph·∫°m">‚ö†Ô∏è Vi ph·∫°m</option>
                                        <option value="Khen th∆∞·ªüng">üèÜ Khen th∆∞·ªüng</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">N·ªôi dung chi ti·∫øt</label>
                                    <textarea class="form-control" name="fault" rows="4" required placeholder="M√¥ t·∫£ l·ªói ho·∫∑c th√†nh t√≠ch..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Ghi ch√∫ th√™m</label>
                                    <input type="text" class="form-control" name="note">
                                </div>
                                <button type="submit" class="btn btn-danger w-100 mt-2" id="btnCompliance">L∆∞u ghi nh·∫≠n</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card card-custom h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-secondary m-0">üìú L·ªãch s·ª≠ Ghi nh·∫≠n</h6>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadCompliance()">üîÑ T·∫£i l·∫°i</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-striped mb-0 table-custom">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Nh√¢n vi√™n</th>
                                            <th>Lo·∫°i</th>
                                            <th>N·ªôi dung</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="complianceBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= CHATBOT UI ================= -->
<button class="chat-btn" onclick="toggleChat()" title="Chat v·ªõi Lily AI">üí¨</button>

<div class="chat-box" id="chatBox">
    <div class="chat-header">
        <span>ü§ñ Lily AI Assistant</span>
        <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
    </div>
    <div class="chat-body" id="chatHistory">
        <div class="msg msg-ai">Xin ch√†o! Em l√† Lily. Anh/Ch·ªã c·∫ßn ki·ªÉm tra ti·∫øn ƒë·ªô c·ªßa ai ·∫°?</div>
    </div>
    <div class="typing" id="typingIndicator">Lily ƒëang nh·∫≠p...</div>
    <div class="chat-footer">
        <input type="text" id="chatInput" class="form-control rounded-pill border-0 bg-light" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
        <button class="btn btn-success rounded-circle" style="width: 38px; height: 38px; padding: 0;" onclick="sendMessage()">‚û§</button>
    </div>
</div>

<!-- ================= MODAL REPORT ================= -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">üì§ B√°o c√°o Ho√†n th√†nh</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reportTaskId">
                <div class="alert alert-info small mb-3">
                    <i class="bi bi-info-circle"></i> Vui l√≤ng ƒë√≠nh k√®m minh ch·ª©ng. H·ªó tr·ª£: ·∫¢nh, PDF, Word, Excel.
                    <br><b>L∆∞u √Ω: File t·ªëi ƒëa 4MB.</b>
                </div>
                <div class="mb-3">
                    <label class="fw-bold small mb-1">File ƒë√≠nh k√®m (B·∫Øt bu·ªôc)</label>
                    <input type="file" id="reportFile" class="form-control" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                    <div class="form-text text-danger small" id="fileError" style="display:none"></div>
                    <div id="uploadProgress" class="progress mt-2" style="display:none; height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 100%"></div>
                    </div>
                    <div class="form-text text-muted small mt-1" id="compressStatus"></div>
                </div>
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success fw-bold" id="btnSubmitReport" onclick="submitReport()">G·ª≠i b√°o c√°o</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL EDIT TASK (ADMIN ONLY) ================= -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">‚úèÔ∏è Ch·ªânh s·ª≠a C√¥ng vi·ªác</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">T√™n c√¥ng vi·ªác</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán (Hi·ªán t·∫°i)</label>
                        <input type="text" class="form-control" id="editTaskAssignee" readonly>
                        <div class="form-text">ƒê·ªÉ thay ƒë·ªïi ng∆∞·ªùi l√†m, vui l√≤ng t·∫°o c√¥ng vi·ªác m·ªõi ho·∫∑c c·∫≠p nh·∫≠t trong Sheet (phi√™n b·∫£n Web h·ªó tr·ª£ s·ª≠a th√¥ng tin c∆° b·∫£n).</div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">H·∫°n ch√≥t</label>
                            <input type="date" class="form-control" id="editTaskDeadline">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ƒê·ªô kh√≥</label>
                            <select class="form-select" id="editTaskDifficulty">
                                <option value="1">‚≠ê D·ªÖ</option>
                                <option value="2">‚≠ê‚≠ê Trung b√¨nh</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê Kh√≥</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Ph·ª©c t·∫°p</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ghi ch√∫</label>
                        <textarea class="form-control" id="editTaskNotes" rows="3"></textarea>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-primary fw-bold" onclick="submitEditTask()">L∆∞u thay ƒë·ªïi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL DUY·ªÜT B√ÅO C√ÅO (M·ªöI) ================= -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold">üìã Duy·ªát B√°o C√°o Ho√†n Th√†nh</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reviewTaskId">
                <div class="mb-3">
                    <label class="fw-bold text-muted small">C√¥ng vi·ªác:</label>
                    <div id="reviewTaskName" class="fw-bold fs-5 text-dark"></div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold text-muted small">Ng∆∞·ªùi th·ª±c hi·ªán:</label>
                    <div id="reviewAssignee"></div>
                </div>
                <div class="card bg-light border-0 mb-3">
                    <div class="card-body p-3">
                        <label class="fw-bold text-muted small mb-2">T√†i li·ªáu minh ch·ª©ng:</label>
                        <div id="reviewFileContainer"></div>
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn btn-danger me-md-2" onclick="submitReviewDecision('reject')">‚ùå Tr·∫£ l·∫°i</button>
                    <button class="btn btn-success" onclick="submitReviewDecision('approve')">‚úÖ Ph√™ duy·ªát</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold text-primary">üîê ƒêƒÉng nh·∫≠p H·ªá th·ªëng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="fw-bold small mb-1">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                    <input type="text" id="loginUsername" class="form-control form-control-lg bg-light" placeholder="V√≠ d·ª•: thuongpb">
                </div>
                <div class="mb-4">
                    <label class="fw-bold small mb-1">M√£ PIN</label>
                    <input type="password" id="loginPin" class="form-control form-control-lg bg-light" placeholder="Nh·∫≠p PIN...">
                </div>
                <button type="button" class="btn btn-primary w-100 btn-lg fw-bold shadow-sm" onclick="performLogin()">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>
</div>

<!-- Change PIN Modal -->
<div class="modal fade" id="changePinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold">üîê ƒê·ªïi M√£ PIN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="fw-bold small">PIN C≈©:</label>
                    <input type="password" id="oldPin" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="fw-bold small">PIN M·ªõi:</label>
                    <input type="password" id="newPin" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="fw-bold small">Nh·∫≠p l·∫°i PIN M·ªõi:</label>
                    <input type="password" id="confirmPin" class="form-control">
                </div>
                <button type="button" class="btn btn-success w-100 fw-bold mt-3" onclick="submitChangePin()">X√°c nh·∫≠n ƒê·ªïi</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- C·∫§U H√åNH ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbynCjJhB-uia5xc1eW1MWJbjkIr7wy7sotQRixmEPu8ecGs4jhRAUJ9aPFnUj5T_s1s/exec";
    
    let globalData = [], globalCompliance = [], currentUser = null;
    let chatContext = []; // L∆∞u l·ªãch s·ª≠ chat
    const STAFF_GROUPS = {
        "Ban L√£nh ƒê·∫°o": ["Nguy·ªÖn Th·ªã H∆∞∆°ng Giang - Tr∆∞·ªüng Khoa", "Tr·∫ßn Th·ªã Huy·ªÅn Trang - Ph√≥ Khoa"],
        "D∆∞·ª£c sƒ©": ["Ph·∫°m B√° Th∆∞∆°ng", "L√™ Th·ªã Thanh Nh√†n", "Chu ƒê√†i Trang", "Nguy·ªÖn Duy Ti·∫øn", "Nguy·ªÖn Th·ªã H·∫±ng", "Ki·ªÅu M·∫°nh To√†n", "ƒê·ªó Th·ªã Nh·∫≠t L·ªá", "Nguy·ªÖn Th·ªã Thu H√†", "H√† Th·ªã Th·∫£o", "Nguy·ªÖn Tu·∫•n Th√†nh", "V≈© Th·ªã H·ªìng H·∫°nh", "H√† Thu Trang", "ƒêo√†n Th·ªã Mai H∆∞∆°ng", "Tri·ªáu Th·ªã V·ªµ"]
    };

    initUI();
    loadTaskList();
    checkSession();

    function initUI() { 
        initCheckboxes();
        initSingleSelect('compliancePerson');
        initGroupSelect();
        toggleDeadline(); 
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7);
        document.getElementById('reportMonthSelect').value = monthStr;
    }
    
    function toggleDeadline() {
        const typeSelect = document.getElementById('taskTypeSelect');
        const dlInput = document.getElementById('deadlineInput');
        if (typeSelect.value === 'Th∆∞·ªùng quy') {
            dlInput.value = ''; dlInput.disabled = true; dlInput.required = false; 
        } else {
            dlInput.disabled = false; dlInput.required = true; 
        }
    }

    function initGroupSelect() {
        const GROUP_LIST = ["T·ªï kho", "T·ªï D∆∞·ª£c l√¢m s√†ng", "T·ªï Trang thi·∫øt b·ªã", "T·ªï Th·ªëng k√™ v√† nghi·ªáp v·ª• d∆∞·ª£c", "T·ªï Truy·ªÅn th√¥ng", "T·ªï 5S", "T·ªï Cung ·ª©ng"];
        const s = document.getElementById('groupSelect');
        s.innerHTML = '<option value="">-- Ch·ªçn t·ªï --</option>';
        GROUP_LIST.forEach(group => { s.innerHTML += `<option value="${group}">${group}</option>`; });
        const f = document.getElementById('filterGroup');
        f.innerHTML = '<option value="">T·∫•t c·∫£</option>';
        GROUP_LIST.forEach(group => { f.innerHTML += `<option value="${group}">${group}</option>`; });
    }

    function initCheckboxes() { 
        const c = document.getElementById('checkboxContainer');
        const h = document.getElementById('hiddenAssigneeSelect');
        const t = document.getElementById('selectedText');
        const n = document.getElementById('selectedCount');
        c.innerHTML = "";
        h.innerHTML = ""; 
        let allStaff = [];
        for(const [group, staffList] of Object.entries(STAFF_GROUPS)){ allStaff.push(...staffList); }
        allStaff = [...new Set(allStaff)];
        allStaff.forEach((name, i) => {
            h.add(new Option(name, name));
            const d = document.createElement('div');
            d.className = 'person-item';
            d.onclick = function(e) { e.stopPropagation(); }
            d.innerHTML = `<input class="form-check-input me-2" type="checkbox" value="${name}" id="chk${i}"><label class="w-100" for="chk${i}">${name}</label>`;
            c.appendChild(d);
            d.querySelector('input').addEventListener('change', (e) => { h.options[i].selected = e.target.checked; updateDisplay(h, t, n); });
        });
    }

    function updateDisplay(s,t,c){
        let cnt=0,nm=[];
        Array.from(s.options).forEach(o=>{if(o.selected){cnt++;nm.push(o.value)}});
        c.innerText=cnt;
        t.innerText=cnt===0?"-- Ch·ªçn nh√¢n s·ª± --":(cnt<=2?nm.join(", "):`ƒê√£ ch·ªçn ${cnt} ng∆∞·ªùi`);
        t.className = cnt>0 ? "text-primary fw-bold" : "text-muted";
    }

    function initSingleSelect(elId) { 
        const s=document.getElementById(elId);
        s.innerHTML='<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>'; 
        for(const[g,ppl] of Object.entries(STAFF_GROUPS)){ 
            const o=document.createElement('optgroup');
            o.label=g; 
            ppl.forEach(n=>o.innerHTML+=`<option value="${n}">${n}</option>`);
            s.appendChild(o); 
        } 
    }

    // --- LOGIC CHATBOT ---
    function toggleChat() {
        if(!currentUser) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ chat v·ªõi Lily AI!");
            showLoginModal();
            return;
        }
        const box = document.getElementById('chatBox');
        box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'flex' : 'none';
        if(box.style.display === 'flex') document.getElementById('chatInput').focus();
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const historyDiv = document.getElementById('chatHistory');
        const typing = document.getElementById('typingIndicator');
        const question = input.value.trim();
        
        if(!question) return;

        historyDiv.innerHTML += `<div class="msg msg-user">${question}</div>`;
        input.value = '';
        historyDiv.scrollTop = historyDiv.scrollHeight;
        typing.style.display = 'block';

        let historyText = chatContext.slice(-6).map(m => `${m.role}: ${m.content}`).join("\n");

        fetch(SCRIPT_URL + "?action=ask_ai", {
            method: 'POST',
            body: JSON.stringify({ 
                question: question,
                history: historyText
            })
        })
        .then(async r => {
            const text = await r.text();
            typing.style.display = 'none'; // Hide typing indicator immediately
            try {
                const res = JSON.parse(text);
                let answer = "";
                if(res.status === 'success') {
                    answer = res.answer;
                } else {
                    answer = "L·ªói Server: " + res.message;
                }
                let displayHtml = answer.replace(/\n/g, '<br>');
                historyDiv.innerHTML += `<div class="msg msg-ai">${displayHtml}</div>`;
                
                // Update context correctly
                chatContext.push({ role: "User", content: question });
                chatContext.push({ role: "Lily", content: answer });

            } catch(e) {
                historyDiv.innerHTML += `<div class="msg msg-ai text-danger">L·ªói ph·∫£n h·ªìi: Server ch∆∞a c·∫•p quy·ªÅn ho·∫∑c API Key sai.<br>Chi ti·∫øt: ${text.substring(0, 100)}...</div>`;
                console.error("AI Error:", text);
            }
            historyDiv.scrollTop = historyDiv.scrollHeight;
        })
        .catch(e => {
            typing.style.display = 'none';
            historyDiv.innerHTML += `<div class="msg msg-ai text-danger">M·∫•t k·∫øt n·ªëi m·∫°ng!</div>`;
        });
    }

    // --- AUTHENTICATION ---
    function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    
    function performLogin() {
        const username = document.getElementById('loginUsername').value, pin = document.getElementById('loginPin').value;
        if(!username || !pin) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        fetch(SCRIPT_URL + "?action=login", { method: 'POST', body: JSON.stringify({ username, pin }) }).then(r => r.json()).then(res => {
            if(res.status === 'success') {
                currentUser = { username: res.username, name: res.name, role: res.role };
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                applyLoginState(); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                alert(`üîì Xin ch√†o ${res.name}`); loadTaskList();
            } else alert("‚õî " + res.message);
        });
    }
    
    function logout() { sessionStorage.removeItem('user'); currentUser = null; applyLoginState(); location.reload(); }
    
    function checkSession() { const saved = sessionStorage.getItem('user'); if(saved) { currentUser = JSON.parse(saved); applyLoginState(); } }
    
    function applyLoginState() {
        const isLoggedIn = !!currentUser;
        document.getElementById('btnLogin').classList.toggle('d-none', isLoggedIn);
        document.getElementById('btnLogout').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('btnChangePin').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('userDisplay').innerText = isLoggedIn ? `üë§ ${currentUser.name}` : "Kh√°ch";
        const isAdmin = currentUser && currentUser.role === 'Admin';
        document.querySelectorAll('.admin-only').forEach(el => el.style.setProperty("display", isAdmin ? "block" : "none", "important"));
    }
    
    function showChangePinModal() { new bootstrap.Modal(document.getElementById('changePinModal')).show(); }
    
    function submitChangePin() {
        const oldPin = document.getElementById('oldPin').value, newPin = document.getElementById('newPin').value, confirmPin = document.getElementById('confirmPin').value;
        if(!oldPin || !newPin) return alert("Thi·∫øu th√¥ng tin!"); if(newPin !== confirmPin) return alert("PIN m·ªõi kh√¥ng kh·ªõp!");
        fetch(SCRIPT_URL + "?action=change_pin", { method: 'POST', body: JSON.stringify({ username: currentUser.username, oldPin, newPin }) }).then(r => r.json()).then(res => { alert(res.message); if(res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('changePinModal')).hide(); logout(); } });
    }

    // --- TASK LOGIC ---
    function loadTaskList() { 
        document.getElementById('taskTableBody').innerHTML='<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>'; 
        fetch(SCRIPT_URL).then(r=>r.json()).then(res=>{ globalData=res.data; populateFilter(); renderTable(); }); 
    }

    function renderTable() {
        const tb = document.getElementById('taskTableBody'); tb.innerHTML="";
        const fG = document.getElementById('filterGroup').value.toLowerCase().trim();
        const fN = document.getElementById('filterAssignee').value.toLowerCase().trim();
        const fS = document.getElementById('filterStatus').value;
        const fD = document.getElementById('filterDifficulty').value; 
        const fT = document.getElementById('filterText').value.toLowerCase().trim();
        const today = new Date(); today.setHours(0,0,0,0);
        
        const getEffectiveStatus = (rawSt, createdStr) => {
            let createdDate = createdStr ? new Date(createdStr) : new Date();
            createdDate.setHours(0,0,0,0);
            if (rawSt === 'Todo' && createdDate < today) return 'Doing';
            return rawSt;
        };

        let flt = globalData.filter(r => {
            let group = String(r[11] || "").toLowerCase();
            let as = String(r[7]).toLowerCase(), rawSt = String(r[2]).trim(), nm = String(r[1]).toLowerCase();
            let diff = String(r[12] || ""); 
            let st = getEffectiveStatus(rawSt, r[6]);
            let statusMatch = true;
            let dlRaw = r[9] || r[4];
            let isOverdue = (dlRaw && new Date(dlRaw) < today && st !== 'Done' && st !== 'Waiting');

            if (fS === 'Pending') statusMatch = (st !== 'Done' && st !== 'Waiting'); 
            else if (fS === 'Done') statusMatch = (st === 'Done');
            else if (fS === 'Waiting') statusMatch = (st === 'Waiting');
            else if (fS === 'Overdue') statusMatch = isOverdue;

            return (fG === "" || group.includes(fG)) && (fN === "" || as.includes(fN)) && (fD === "" || diff === fD) && statusMatch && (fT === "" || nm.includes(fT));
        });
        
        flt.sort((a, b) => {
            const grpA = (a[11] || "").toLowerCase(), grpB = (b[11] || "").toLowerCase(); if (grpA < grpB) return -1; if (grpA > grpB) return 1;
            const statusA = getEffectiveStatus(String(a[2]).trim(), a[6]);
            const statusB = getEffectiveStatus(String(b[2]).trim(), b[6]);
            if (statusA === 'Waiting' && statusB !== 'Waiting') return -1; if (statusA !== 'Waiting' && statusB === 'Waiting') return 1;
            const doneA = statusA === 'Done', doneB = statusB === 'Done'; if (doneA && !doneB) return 1; if (!doneA && doneB) return -1;
            const dateA = new Date(a[9] || a[4] || '9999-12-31'); const dateB = new Date(b[9] || b[4] || '9999-12-31'); return dateA - dateB;
        });
        
        if(flt.length === 0) { tb.innerHTML='<tr><td colspan="7" class="text-center text-muted py-4">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</td></tr>'; return; }

        flt.forEach(r => {
            let id = r[0], name = r[1], rawStatus = String(r[2]).trim(), assignee = r[7];
            let type = r[10] || "Th∆∞·ªùng quy", group = r[11] || ""; 
            let difficulty = r[12] || ""; 
            let status = getEffectiveStatus(rawStatus, r[6]);
            let dlRaw = r[9] || r[4], dlDisp = dlRaw ? new Date(dlRaw).toLocaleDateString('vi-VN') : '';
            let fileUrl = r[13] || ""; // C·ªôt N (Index 13) l∆∞u file

            let prog = parseProgress(r[8]);
            let isOwner = currentUser && (currentUser.role === 'Admin' || assignee.includes(currentUser.name));
            let disableControl = isOwner ? "" : "pointer-events: none; opacity: 0.6;";
            let isOverdue = false;
            if (dlRaw && new Date(dlRaw) < today && status !== 'Done' && status !== 'Waiting') isOverdue = true;

            let badgeClass = '';
            let statusText = status;
            
            if (status === 'Done') { badgeClass = 'bg-done'; statusText = 'Ho√†n th√†nh'; }
            else if (status === 'Waiting') { badgeClass = 'bg-waiting'; statusText = 'Ch·ªù duy·ªát'; }
            else if (isOverdue) { badgeClass = 'bg-overdue'; statusText = 'Qu√° h·∫°n'; }
            else if (status === 'Doing') { badgeClass = 'bg-doing'; statusText = 'ƒêang l√†m'; }
            else { badgeClass = 'bg-todo'; statusText = 'M·ªõi t·∫°o'; }

            let dlHtml = '';
            if (!dlRaw || type === 'Th∆∞·ªùng quy') {
                 dlHtml = '<span class="badge bg-light text-secondary border">üîÑ Th∆∞·ªùng quy</span>';
            } else {
                dlHtml = dlDisp;
                if (r[9] && r[9] !== r[4]) dlHtml = `<span class="deadline-original">${new Date(r[4]).toLocaleDateString('vi-VN')}</span><br><span class="deadline-extended">‚Ü≥ ${dlDisp}</span>`;
                if (isOverdue) dlHtml = `<span class="text-danger fw-bold">‚ö†Ô∏è ${dlHtml}</span>`;
            }

            let slider = status === 'Done' 
                ? `<div class="progress" style="height:8px;"><div class="progress-bar bg-success" style="width:100%"></div></div><small class="text-success fw-bold">100%</small>` 
                : `<div class="d-flex align-items-center" style="${disableControl}"><input type="range" class="form-range me-2" style="width:80px" min="0" max="100" step="10" value="${prog}" onchange="updateProgress('${id}',this.value)"><span class="badge bg-light text-dark border" id="val-${id}">${prog}%</span></div>`;

            // --- LOGIC PH√ÇN QUY·ªÄN N√öT B·∫§M ---
            let actionBtns = '';
            // N√∫t xem File (Hi·ªÉn th·ªã cho Admin khi Waiting ho·∫∑c khi ƒë√£ xong)
            let attachLink = (fileUrl && currentUser && currentUser.role === 'Admin') 
                ? `<div class="mb-1"><a href="${fileUrl}" target="_blank" class="btn btn-sm btn-info text-white text-decoration-none" title="Xem b√°o c√°o"><i class="bi bi-file-earmark-text"></i> üìÑ Xem B√°o c√°o</a></div>` 
                : '';

            if (status === 'Done') {
                actionBtns = '<span class="text-success fw-bold">‚úî Ho√†n t·∫•t</span>';
            } else if (status === 'Waiting') {
                actionBtns = attachLink;
                if (currentUser && currentUser.role === 'Admin') {
                    // Admin: S·ª≠ d·ª•ng Modal Review ƒë·ªÉ duy·ªát
                    actionBtns += `
                    <div class="d-flex gap-1 justify-content-center mt-1">
                        <button class="btn btn-sm btn-success" onclick="approveTask('${id}')" title="Duy·ªát">‚úÖ Duy·ªát</button>
                        <button class="btn btn-sm btn-danger" onclick="rejectTask('${id}')" title="T·ª´ ch·ªëi">‚ùå</button>
                    </div>`;
                } else {
                    // Member: Ch·ªù
                    actionBtns += `<span class="text-muted fst-italic small">‚è≥ ƒêang ch·ªù duy·ªát...</span>`;
                }
            } else {
                // Todo, Doing, Overdue
                if (currentUser && currentUser.role === 'Admin') {
                    actionBtns = `<button class="btn btn-sm btn-outline-success w-100 mb-1" onclick="approveTask('${id}')">‚úÖ Duy·ªát ngay</button>`;
                } else {
                    actionBtns = `<div class="btn-action-group" style="${disableControl}">
                        <button class="btn btn-sm btn-outline-primary w-100 mb-1" onclick="openReportModal('${id}')">üì© B√°o c√°o</button>
                        <button class="btn btn-sm btn-outline-warning w-100 text-dark" onclick="sendEmailBackend('${id}','${name}','${assignee}','${dlRaw}')">üìß Nh·∫Øc</button>
                    </div>`;
                }
            }

            let groupBadge = group ? `<span class="badge bg-secondary mb-1" style="font-size:0.7em">${group}</span>` : '';
            let diffHtml = '<span class="text-muted small">-</span>';
            if(difficulty) {
                if(difficulty == '1') diffHtml = '<span class="badge-diff diff-easy">‚≠ê D·ªÖ</span>';
                else if(difficulty == '2') diffHtml = '<span class="badge-diff diff-medium">‚≠ê‚≠ê TB</span>';
                else if(difficulty == '3') diffHtml = '<span class="badge-diff diff-hard">‚≠ê‚≠ê‚≠ê Kh√≥</span>';
                else if(difficulty == '4') diffHtml = '<span class="badge-diff diff-complex">‚≠ê‚≠ê‚≠ê‚≠ê Ph·ª©c t·∫°p</span>';
            }

            // N√∫t s·ª≠a cho Admin
            let editBtn = '';
            if (currentUser && currentUser.role === 'Admin') {
                editBtn = `<button class="btn btn-sm btn-link text-secondary p-0 ms-2" onclick="openEditTask('${id}')" title="S·ª≠a c√¥ng vi·ªác">‚úèÔ∏è</button>`;
            }

            tb.innerHTML += `<tr class="${isOverdue ? 'table-danger' : ''}">
                <td>
                    ${groupBadge} 
                    <div class="d-flex align-items-center">
                        <span class="fw-bold text-dark">${name}</span>
                        ${editBtn}
                    </div>
                    <div class="text-muted small mt-1"><em>${r[5] || ''}</em></div>
                </td>
                <td class="text-center">${diffHtml}</td>
                <td>${slider}</td>
                <td><small class="fw-bold text-primary">${assignee}</small></td>
                <td class="small">${dlHtml}</td>
                <td><span class="badge badge-status ${badgeClass}">${statusText}</span></td>
                <td class="text-center align-middle">${actionBtns}</td>
            </tr>`;
        });
    }
    
    function parseProgress(val) { if(!val)return 0; let s=String(val).replace(/^'/,'').replace('%','').trim(); let n=parseFloat(s); return isNaN(n)?0:(n<=1&&n>0&&s.includes('.')?Math.round(n*100):Math.round(n)); }
    function populateFilter() { const s = document.getElementById('filterAssignee'); s.innerHTML = '<option value="">T·∫•t c·∫£</option>'; let a = []; globalData.forEach(r => a.push(...String(r[7]).split(',').map(v => v.trim()).filter(v => v))); [...new Set(a)].sort().forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); }

    function updateProgress(id, v) { 
        if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); 
        if(v == 100 && currentUser.role !== 'Admin') {
            if(confirm("B·∫°n mu·ªën b√°o c√°o ho√†n th√†nh c√¥ng vi·ªác n√†y?")) {
                openReportModal(id);
                document.getElementById(`val-${id}`).innerText='100%'; 
                return;
            } else {
                v = 90; 
            }
        }
        document.getElementById(`val-${id}`).innerText=v+'%'; 
        fetch(SCRIPT_URL+"?action=update_progress",{method:'POST',body:JSON.stringify({id:id,progress:v, user_fullname: currentUser.name, role: currentUser.role})})
        .then(r=>r.json()).then(res=>{if(res.status==='error'){alert(res.message); loadTaskList();} else if(v==100 && currentUser.role === 'Admin') loadTaskList()}); 
    }
    
    // --- REPORT LOGIC (FIXED) ---
    function openReportModal(id) {
        if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
        document.getElementById('reportTaskId').value = id;
        document.getElementById('reportFile').value = '';
        document.getElementById('fileError').style.display = 'none';
        document.getElementById('compressStatus').innerText = '';
        document.getElementById('uploadProgress').style.display = 'none';
        new bootstrap.Modal(document.getElementById('reportModal')).show();
    }

    function getMimeType(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const map = {
            'pdf': 'application/pdf',
            'doc': 'application/msword',
            'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'xls': 'application/vnd.ms-excel',
            'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'ppt': 'application/vnd.ms-powerpoint',
            'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'png': 'image/png'
        };
        return map[ext] || 'application/octet-stream';
    }

    async function submitReport() {
        const id = document.getElementById('reportTaskId').value;
        const fileInput = document.getElementById('reportFile');
        const file = fileInput.files[0];
        const btn = document.getElementById('btnSubmitReport');
        const errDiv = document.getElementById('fileError');
        const statusDiv = document.getElementById('compressStatus');
        const progressDiv = document.getElementById('uploadProgress');

        if(!file) { errDiv.innerText = "Vui l√≤ng ch·ªçn file!"; errDiv.style.display = 'block'; return; }
        
        // Check size (4MB limit for safe Base64)
        if(file.size > 4 * 1024 * 1024) {
            errDiv.innerText = "File qu√° l·ªõn (>4MB). Vui l√≤ng n√©n nh·ªè l·∫°i tr∆∞·ªõc khi g·ª≠i."; 
            errDiv.style.display = 'block';
            return;
        }

        btn.disabled = true;
        btn.innerText = "ƒêang x·ª≠ l√Ω...";
        errDiv.style.display = 'none';
        progressDiv.style.display = 'block';

        let base64Data = "";
        let finalFileName = file.name;
        // T·ª± ƒë·ªông nh·∫≠n di·ªán MIME type n·∫øu tr√¨nh duy·ªát kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c (v√≠ d·ª• file .docx tr√™n m·ªôt s·ªë m√°y)
        let finalMimeType = file.type || getMimeType(file.name);

        statusDiv.innerText = "ƒêang ƒë·ªçc file...";
        
        try {
            base64Data = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        } catch (e) {
            console.error(e);
            errDiv.innerText = "L·ªói ƒë·ªçc file tr√™n thi·∫øt b·ªã."; errDiv.style.display = 'block';
            btn.disabled = false; btn.innerText = "G·ª≠i b√°o c√°o";
            return;
        }

        statusDiv.innerText = "ƒêang g·ª≠i l√™n m√°y ch·ªß (Vui l√≤ng ch·ªù)...";

        // G·ª≠i l√™n Server
        const payload = {
            id: id,
            user_fullname: currentUser.name,
            fileName: finalFileName,
            mimeType: finalMimeType,
            fileData: base64Data
        };

        fetch(SCRIPT_URL + "?action=report_done", {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(async r => {
            const text = await r.text();
            try {
                const res = JSON.parse(text);
                if(res.status === 'success') {
                    alert("‚úÖ " + res.message);
                    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
                    loadTaskList();
                } else {
                    alert("‚ö†Ô∏è L·ªói t·ª´ Server: " + res.message);
                }
            } catch(e) {
                console.error("Report Error:", text);
                alert("L·ªói ph·∫£n h·ªìi t·ª´ Server. C√≥ th·ªÉ do m·∫°ng y·∫øu ho·∫∑c file b·ªã ch·∫∑n.");
            }
        })
        .catch(err => {
            alert("L·ªói k·∫øt n·ªëi m·∫°ng: " + err);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "G·ª≠i b√°o c√°o";
            progressDiv.style.display = 'none';
            statusDiv.innerText = "";
        });
    }

    function approveTask(id) {
        if(!currentUser || currentUser.role !== 'Admin') return alert("‚õî Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c duy·ªát!");
        if(!confirm('Duy·ªát ho√†n th√†nh c√¥ng vi·ªác n√†y?')) return;

        fetch(SCRIPT_URL + "?action=approve_done", {
            method: 'POST',
            body: JSON.stringify({id: id, role: currentUser.role})
        })
        .then(r => r.json())
        .then(res => { alert(res.message); loadTaskList(); });
    }

    function rejectTask(id) {
        if(!currentUser || currentUser.role !== 'Admin') return alert("‚õî Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c quy·ªÅn n√†y!");
        if(!confirm('T·ª´ ch·ªëi b√°o c√°o n√†y v√† y√™u c·∫ßu l√†m l·∫°i?')) return;

        fetch(SCRIPT_URL + "?action=reject_done", {
            method: 'POST',
            body: JSON.stringify({id: id, role: currentUser.role})
        })
        .then(r => r.json())
        .then(res => { alert(res.message); loadTaskList(); });
    }
    
    // --- EDIT TASK LOGIC (NEW) ---
    function openEditTask(id) {
        const task = globalData.find(r => r[0] == id);
        if(!task) return;
        document.getElementById('editTaskId').value = id;
        document.getElementById('editTaskName').value = task[1];
        document.getElementById('editTaskAssignee').value = task[7]; // Assignee is readonly in edit for simplicity
        document.getElementById('editTaskNotes').value = task[5] || '';
        
        // Populate Date
        let deadline = task[9] || task[4];
        if(deadline) {
            let d = new Date(deadline);
            let day = ("0" + d.getDate()).slice(-2);
            let month = ("0" + (d.getMonth() + 1)).slice(-2);
            let today = d.getFullYear()+"-"+(month)+"-"+(day);
            document.getElementById('editTaskDeadline').value = today;
        } else {
            document.getElementById('editTaskDeadline').value = '';
        }
        
        // Populate Difficulty
        let diff = task[12];
        if(diff) document.getElementById('editTaskDifficulty').value = diff;

        new bootstrap.Modal(document.getElementById('editTaskModal')).show();
    }

    function submitEditTask() {
        const id = document.getElementById('editTaskId').value;
        const name = document.getElementById('editTaskName').value;
        const deadline = document.getElementById('editTaskDeadline').value;
        const diff = document.getElementById('editTaskDifficulty').value;
        const notes = document.getElementById('editTaskNotes').value;
        
        const payload = {
            id: id,
            taskName: name,
            deadline: deadline,
            difficulty: diff,
            notes: notes,
            role: currentUser.role
        };
        
        fetch(SCRIPT_URL + "?action=edit_task", {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(r => r.json())
        .then(res => {
            alert(res.message);
            bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
            loadTaskList();
        });
    }

    // --- REVIEW MODAL LOGIC (NEW) ---
    function openReviewModal(id) {
        const task = globalData.find(r => r[0] == id);
        if(!task) return;
        
        document.getElementById('reviewTaskId').value = id;
        document.getElementById('reviewTaskName').innerText = task[1];
        document.getElementById('reviewAssignee').innerText = task[7];
        
        const fileUrl = task[13]; // C·ªôt N (Index 13)
        const container = document.getElementById('reviewFileContainer');
        if (fileUrl) {
            container.innerHTML = `<a href="${fileUrl}" target="_blank" class="btn btn-outline-primary w-100 fw-bold"><i class="bi bi-file-earmark-text"></i> M·ªü File B√°o C√°o</a>`;
        } else {
            container.innerHTML = `<span class="text-muted fst-italic">Kh√¥ng c√≥ file ƒë√≠nh k√®m.</span>`;
        }
        
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
    }

    function submitReviewDecision(type) {
        const id = document.getElementById('reviewTaskId').value;
        if (type === 'approve') {
            approveTask(id);
        } else {
            rejectTask(id);
        }
        bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
    }

    function sendEmailBackend(id,t,p,d){ 
        if(!confirm(`G·ª≠i mail nh·∫Øc nh·ªü cho ${p}?`))return; 
        let dl=d?new Date(d).toLocaleDateString('vi-VN'):'S·ªõm nh·∫•t'; const btn=event.target; const txt=btn.innerText; btn.innerText="‚è≥..."; btn.disabled=true; 
        fetch(SCRIPT_URL+"?action=send_email_manual",{method:'POST',body:JSON.stringify({taskName:t,assignee:p,deadline:dl})})
        .then(r=>r.json()).then(res=>{alert(res.message)}).finally(()=>{btn.innerText=txt;btn.disabled=false}); 
    }
    
    function triggerBulkEmail() { 
        if(!currentUser || currentUser.role !== 'Admin') return alert("‚õî Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn n√†y!"); 
        const pending=globalData.filter(r=>String(r[2]).trim()!=='Done'); 
        if(pending.length===0) return alert("Kh√¥ng c√≥ vi·ªác c·∫ßn g·ª≠i!"); 
        if(!confirm(`G·ª≠i mail nh·∫Øc vi·ªác cho ${pending.length} ƒë·∫ßu vi·ªác ch∆∞a xong?`))return; 
        const btn=event.target;const t=btn.innerText;btn.innerText="‚è≥ G·ª≠i...";btn.disabled=true; 
        fetch(SCRIPT_URL+"?action=send_bulk_email",{method:'POST',body:JSON.stringify({taskIds:pending.map(r=>r[0]),sender:currentUser.name})})
        .then(r=>r.json()).then(res=>alert(res.message)).finally(()=>{btn.innerText=t;btn.disabled=false}); 
    }

    document.getElementById('taskForm').addEventListener('submit', e => { 
        e.preventDefault(); 
        if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} 
        const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerText = "‚è≥ ƒêang l∆∞u...";
        const d=Object.fromEntries(new FormData(e.target).entries()); 
        d.assignee=Array.from(document.getElementById('hiddenAssigneeSelect').selectedOptions).map(o=>o.value).join(', '); d.role=currentUser.role; 
        fetch(SCRIPT_URL+"?action=add",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ 
            alert(res.message); if(res.status==='success'){ e.target.reset(); document.querySelectorAll('#checkboxContainer input').forEach(c=>c.checked=false); updateDisplay(document.getElementById('hiddenAssigneeSelect'),document.getElementById('selectedText'),document.getElementById('selectedCount')); document.querySelector('[data-bs-target="#pills-list"]').click(); loadTaskList(); } 
        }).finally(()=>{btn.disabled=false; btn.innerText = "üíæ L∆ØU C√îNG VI·ªÜC";}); 
    });

    document.getElementById('complianceForm').addEventListener('submit', e => { 
        e.preventDefault(); if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} 
        const btn=document.getElementById('btnCompliance'); btn.disabled=true; 
        const d=Object.fromEntries(new FormData(e.target).entries()); d.role=currentUser.role; 
        fetch(SCRIPT_URL+"?action=add_compliance",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ 
            alert(res.message); if(res.status==='success'){e.target.reset(); loadCompliance();} 
        }).finally(()=>{btn.disabled=false;}); 
    });

    function loadCompliance(){
        const tb=document.getElementById('complianceBody');tb.innerHTML='<tr><td colspan="5" class="text-center">Loading...</td></tr>'; 
        fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json()).then(res=>{ 
            globalCompliance = res.data || []; tb.innerHTML=""; 
            if(!res.data||!res.data.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';return;} 
            res.data.reverse().forEach(r=>{ 
                let h=r.length>=6,t=h?r[3]:(r[3].includes("Khen")?"Khen th∆∞·ªüng":"Vi ph·∫°m"),c=h?r[4]:r[3],n=h?r[5]:r[4];
                let b=t.includes("Khen")?'<span class="badge bg-warning text-dark">üèÜ Khen th∆∞·ªüng</span>':'<span class="badge bg-danger">‚ö†Ô∏è Vi ph·∫°m</span>'; 
                tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString('vi-VN')}</td><td class="fw-bold">${r[2]}</td><td>${b}</td><td>${c}</td><td>${n||''}</td></tr>`; 
            }); 
        }); 
    }

    google.charts.load('current',{'packages':['corechart','bar']});
    function loadDashboard() { 
        document.getElementById('calendar').innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
        Promise.all([fetch(SCRIPT_URL).then(r=>r.json()), fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json())]).then(([taskRes, compRes]) => { 
            globalData = taskRes.data || []; globalCompliance = compRes.data || []; updateReport(); 
        }); 
    }

    function updateReport() {
        const monthStr = document.getElementById('reportMonthSelect').value; if (!monthStr) return;
        const [year, month] = monthStr.split('-').map(Number);
        const startOfMonth = new Date(year, month - 1, 1); const endOfMonth = new Date(year, month, 0, 23, 59, 59); const today = new Date(); today.setHours(0,0,0,0);
        const filteredTasks = globalData.filter(r => { const created = new Date(r[6]); let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date()); return created <= endOfMonth && deadline >= startOfMonth; });
        const filteredCompliance = globalCompliance.filter(r => { const date = new Date(r[1]); return date >= startOfMonth && date <= endOfMonth; });
        drawCharts(filteredTasks, filteredCompliance); renderCal(filteredTasks, filteredCompliance, today);
    }

    function drawCharts(t,c) { 
        var stats = {'Done': 0, 'Doing': 0, 'Overdue': 0}; var diffStats = {'1': 0, '2': 0, '3': 0, '4': 0, 'Unknown': 0}; var p = {}; var today = new Date(); today.setHours(0,0,0,0);
        t.forEach(r => {
            let status = String(r[2]).trim(); let dlRaw = r[9] || r[4]; let dl = dlRaw ? new Date(dlRaw) : null; let isOverdue = (status !== 'Done' && dl && dl < today); let diff = r[12] || 'Unknown';
            if (status === 'Done') stats.Done++; else if (isOverdue) stats.Overdue++; else stats.Doing++;
            if (diffStats[diff] !== undefined) diffStats[diff]++; else diffStats['Unknown']++;
            String(r[7]).split(',').forEach(n=>{ n=n.trim(); if(n){ if(!p[n]) p[n] = { done: 0, overdue: 0, normal: 0 }; if (status === 'Done') p[n].done++; else if (isOverdue) p[n].overdue++; else p[n].normal++; } });
        }); 
        var pieData = google.visualization.arrayToDataTable([['Tr·∫°ng th√°i', 'S·ªë l∆∞·ª£ng'],['ƒê√£ xong', stats.Done],['ƒêang l√†m', stats.Doing],['Qu√° h·∫°n', stats.Overdue]]);
        new google.visualization.PieChart(document.getElementById('piechart_task')).draw(pieData, { colors: ['#198754', '#0dcaf0', '#dc3545'], is3D: false, pieHole: 0.4, legend: {position: 'bottom'}, chartArea:{width:'90%',height:'80%'} }); 
        var diffData = google.visualization.arrayToDataTable([['ƒê·ªô kh√≥', 'S·ªë l∆∞·ª£ng'],['D·ªÖ', diffStats['1']],['Trung b√¨nh', diffStats['2']],['Kh√≥', diffStats['3']],['Ph·ª©c t·∫°p', diffStats['4']]]);
        new google.visualization.PieChart(document.getElementById('piechart_difficulty')).draw(diffData, { colors: ['#a3cfbb', '#ffe5d0', '#f5c2c7', '#e0cffc'], is3D: false, pieHole: 0.4, legend: {position: 'bottom'}, chartArea:{width:'90%',height:'80%'} });
        var arr = [['Nh√¢n vi√™n', 'ƒê√£ xong', 'ƒêang l√†m', 'Qu√° h·∫°n']]; Object.keys(p).sort().forEach(k => { arr.push([k, p[k].done, p[k].normal, p[k].overdue]); });
        if(arr.length > 1) new google.visualization.ColumnChart(document.getElementById('barchart_task')).draw(google.visualization.arrayToDataTable(arr),{ isStacked: true, colors: ['#198754', '#0dcaf0', '#dc3545'], legend: { position: 'bottom' }, chartArea: {width:'85%', height:'70%'} }); 
        var pc={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pc[n])pc[n]=0;if(!tp.includes("Khen"))pc[n]++;}); 
        var ac=[['NV','Vi ph·∫°m',{role:"style"}]]; Object.keys(pc).sort().forEach(k=>{if(pc[k]>0)ac.push([k,pc[k],'#dc3545']);}); 
        if(ac.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_violation')).draw(google.visualization.arrayToDataTable(ac),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_violation').innerHTML="<div class='d-flex align-items-center justify-content-center h-100 text-muted'>Tr·ªëng</div>";
        var pr={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pr[n])pr[n]=0;if(tp.includes("Khen"))pr[n]++;}); 
        var ar=[['NV','Khen th∆∞·ªüng',{role:"style"}]]; Object.keys(pr).sort().forEach(k=>{if(pr[k]>0)ar.push([k,pr[k],'#ffc107']);}); 
        if(ar.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_reward')).draw(google.visualization.arrayToDataTable(ar),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_reward').innerHTML="<div class='d-flex align-items-center justify-content-center h-100 text-muted'>Tr·ªëng</div>";
    }

    function exportExcelReport() {
        const monthStr = document.getElementById('reportMonthSelect').value; const [year, month] = monthStr.split('-').map(Number);
        const startOfMonth = new Date(year, month - 1, 1); const endOfMonth = new Date(year, month, 0, 23, 59, 59);
        const taskData = globalData.filter(r => { const created = new Date(r[6]); let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date()); return created <= endOfMonth && deadline >= startOfMonth; })
            .map(r => ({ "T√™n c√¥ng vi·ªác": r[1], "T·ªï": r[11] || "", "Ng∆∞·ªùi th·ª±c hi·ªán": r[7], "Tr·∫°ng th√°i": r[2], "Ng√†y t·∫°o": new Date(r[6]).toLocaleDateString('vi-VN'), "Deadline": r[9] ? new Date(r[9]).toLocaleDateString('vi-VN') : (r[4] ? new Date(r[4]).toLocaleDateString('vi-VN') : ""), "Ti·∫øn ƒë·ªô": r[8] + "%", "Ghi ch√∫": r[5] }));
        const complianceData = globalCompliance.filter(r => { const date = new Date(r[1]); return date >= startOfMonth && date <= endOfMonth; })
            .map(r => { let h=r.length>=6; return { "Ng√†y": new Date(r[1]).toLocaleDateString('vi-VN'), "Nh√¢n vi√™n": r[2], "Lo·∫°i": h?r[3]:(r[3].includes("Khen")?"Khen th∆∞·ªüng":"Vi ph·∫°m"), "N·ªôi dung": h?r[4]:r[3], "Ghi ch√∫": h?r[5]:r[4] }; });
        const wb = XLSX.utils.book_new();
        if (taskData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(taskData), "CongViec"); else XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{"Note": "Kh√¥ng c√≥ d·ªØ li·ªáu"}]), "CongViec");
        if (complianceData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(complianceData), "NoiQuy");
        XLSX.writeFile(wb, `BaoCao_KhoaDuoc_${monthStr}.xlsx`);
    }
</script>
</body>
</html>

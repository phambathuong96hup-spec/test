<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c - Pro</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Libraries -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #0f9d58; /* Google Green */
            --secondary-color: #e8f5e9;
            --text-dark: #2c3e50;
            --bg-body: #f8f9fa;
            --card-radius: 16px;
            --transition: all 0.3s ease;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        /* Header & Nav */
        .header-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0 0 var(--card-radius) var(--card-radius);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .nav-pills {
            background: #f1f3f4;
            padding: 5px;
            border-radius: 12px;
            display: inline-flex;
            width: 100%;
        }

        .nav-pills .nav-item {
            flex: 1;
        }

        .nav-pills .nav-link {
            color: #5f6368;
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 15px;
            transition: var(--transition);
        }

        .nav-pills .nav-link.active {
            background-color: white;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .nav-pills .nav-link:hover:not(.active) {
            background-color: rgba(0,0,0,0.05);
        }

        /* Cards */
        .card-custom {
            border: none;
            border-radius: var(--card-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            transition: var(--transition);
            overflow: hidden;
        }

        .card-custom:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.06);
            transform: translateY(-2px);
        }

        .card-header-custom {
            background: var(--secondary-color);
            padding: 15px 20px;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid rgba(15, 157, 88, 0.1);
        }

        /* Table */
        .table-custom thead th {
            background-color: #f1f3f4;
            color: #444;
            font-weight: 600;
            border: none;
            text-transform: uppercase;
            font-size: 0.8rem;
            padding: 12px;
        }
        .table-custom tbody td {
            padding: 12px;
            vertical-align: middle;
        }
        .table-hover tbody tr:hover {
            background-color: #f8fff9;
        }

        /* Status Badges */
        .badge-status { padding: 6px 10px; border-radius: 6px; font-weight: 500; font-size: 0.75rem; }
        .bg-todo { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .bg-doing { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
        .bg-done { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .bg-overdue { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

        /* Custom Inputs */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 10px 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(15, 157, 88, 0.25);
        }

        /* Calendar Styling */
        #calendar {
            background: white;
            padding: 15px;
            border-radius: var(--card-radius);
        }
        .fc-event {
            border: none !important;
            border-radius: 4px !important;
            padding: 2px 4px !important;
            font-size: 0.8rem !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .fc-day-today {
            background-color: #f0fdf4 !important; /* Light green for today */
        }
        .fc-toolbar-title {
            font-size: 1.2rem !important;
            font-weight: 700;
            color: var(--primary-color);
        }
        .fc-button-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        /* Utilities */
        .admin-only, .logged-only { display: none !important; }
        .deadline-extended { color: #6f42c1; font-weight: 700; }
        .deadline-original { text-decoration: line-through; color: #aaa; font-size: 0.8em; }
        
        .person-item { padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; }
        .person-item:hover { background-color: #f5f5f5; }
        .person-item input { margin-right: 10px; transform: scale(1.1); }
        .dropdown-menu-custom { max-height: 250px; overflow-y: auto; padding: 0; }
        
        .btn-action-group .btn {
            margin-right: 4px;
            margin-bottom: 4px;
        }
        
        /* Floating Action Button for Mobile (Optional, kept hidden for now) */
        .fab { position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 1000; }
    </style>
</head>
<body>

<div class="container-xxl py-3">
    <!-- Header -->
    <div class="header-section d-flex flex-wrap justify-content-between align-items-center">
        <div class="d-flex align-items-center mb-2 mb-md-0">
            <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; font-size: 24px;">üè•</div>
            <div>
                <h4 class="fw-bold m-0" style="color: var(--primary-color);">KHOA D∆Ø·ª¢C</h4>
                <small class="text-muted">H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng vi·ªác & N·ªôi quy</small>
            </div>
        </div>
        
        <div class="d-flex align-items-center gap-2">
            <span id="userDisplay" class="fw-bold text-dark bg-light px-3 py-2 rounded-pill border"></span>
            <button class="btn btn-outline-secondary btn-sm d-none" id="btnChangePin" onclick="showChangePinModal()">üîê ƒê·ªïi PIN</button>
            <button class="btn btn-primary btn-sm px-3 rounded-pill fw-bold" id="btnLogin" onclick="showLoginModal()">üë§ ƒêƒÉng nh·∫≠p</button>
            <button class="btn btn-outline-danger btn-sm px-3 rounded-pill d-none" id="btnLogout" onclick="logout()">üö™ Tho√°t</button>
        </div>
    </div>

    <!-- Navigation -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">
                üìã Danh s√°ch
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">
                üìä B√°o c√°o & L·ªãch
            </button>
        </li>
        <li class="nav-item admin-only" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-input">
                üìù Giao vi·ªác
            </button>
        </li>
        <li class="nav-item admin-only" role="presentation">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-compliance">
                ‚öñÔ∏è N·ªôi quy
            </button>
        </li>
    </ul>

    <!-- Content -->
    <div class="tab-content" id="pills-tabContent">
        
        <!-- TAB 1: DANH S√ÅCH C√îNG VI·ªÜC -->
        <div class="tab-pane fade show active" id="pills-list">
            <div class="card card-custom p-3 mb-3">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">B·ªô ph·∫≠n</label>
                        <select id="filterGroup" class="form-select form-select-sm" onchange="renderTable()"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted fw-bold">Nh√¢n s·ª±</label>
                        <select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">Tr·∫°ng th√°i</label>
                        <select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Todo">Ch∆∞a xong</option>
                            <option value="Done">ƒê√£ xong</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted fw-bold">T√¨m ki·∫øm</label>
                        <input type="text" id="filterText" class="form-control form-control-sm" placeholder="T√™n c√¥ng vi·ªác..." onkeyup="renderTable()">
                    </div>
                    <div class="col-md-2 d-flex align-items-end gap-1">
                        <button class="btn btn-warning btn-sm w-100 fw-bold text-dark admin-only" onclick="triggerBulkEmail()" title="G·ª≠i mail nh·∫Øc vi·ªác ch∆∞a xong">üì® Nh·∫Øc All</button>
                        <button class="btn btn-light border btn-sm" onclick="loadTaskList()" title="T·∫£i l·∫°i"><span style="font-size: 1.2em;">üîÑ</span></button>
                    </div>
                </div>
            </div>

            <div class="card card-custom">
                <div class="table-responsive">
                    <table class="table table-hover table-custom mb-0">
                        <thead>
                            <tr>
                                <th width="35%">C√¥ng vi·ªác / T·ªï</th>
                                <th width="20%">Ti·∫øn ƒë·ªô</th>
                                <th width="15%">Ng∆∞·ªùi th·ª±c hi·ªán</th>
                                <th width="12%">Deadline</th>
                                <th width="10%">Tr·∫°ng th√°i</th>
                                <th width="8%" class="text-center">T√°c v·ª•</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 2: B√ÅO C√ÅO & L·ªäCH -->
        <div class="tab-pane fade" id="pills-report">
            <!-- Filter Bar -->
            <div class="card card-custom p-3 mb-4 bg-white border-start border-5 border-success">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="fw-bold text-success fs-5">üìÖ B√ÅO C√ÅO TH√ÅNG:</span>
                        <input type="month" id="reportMonthSelect" class="form-control form-control-lg" style="width: auto;" onchange="updateReport()">
                    </div>
                    <button class="btn btn-success fw-bold shadow-sm px-4" onclick="exportExcelReport()">
                        üì• Xu·∫•t Excel
                    </button>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-lg-3">
                    <div class="card card-custom h-100">
                        <div class="card-header-custom text-center">üìä T√¨nh tr·∫°ng chung</div>
                        <div class="card-body p-0 d-flex justify-content-center align-items-center">
                            <div id="piechart_task" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-5">
                    <div class="card card-custom h-100">
                        <div class="card-header-custom text-center">üìà Chi ti·∫øt nh√¢n s·ª±</div>
                        <div class="card-body p-0">
                            <div id="barchart_task" style="width: 100%; height: 250px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-2">
                    <div class="card card-custom h-100 border-start border-4 border-danger">
                        <div class="p-2 text-center text-danger fw-bold bg-light">‚ö†Ô∏è Vi ph·∫°m</div>
                        <div class="card-body p-0">
                            <div id="columnchart_violation" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-2">
                    <div class="card card-custom h-100 border-start border-4 border-warning">
                        <div class="p-2 text-center text-warning fw-bold bg-light">üèÜ Khen th∆∞·ªüng</div>
                        <div class="card-body p-0">
                            <div id="columnchart_reward" style="width: 100%; height: 220px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="card card-custom p-1">
                <div class="card-header-custom bg-white text-dark d-flex justify-content-between align-items-center">
                    <span>üìÖ L·ªäCH C√îNG T√ÅC & DEADLINE</span>
                    <div class="d-flex gap-2 small">
                        <span class="badge bg-success">ƒê√£ xong</span>
                        <span class="badge bg-danger">Qu√° h·∫°n</span>
                        <span class="badge bg-primary">S·∫Øp t·ªõi</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- TAB 3: GIAO VI·ªÜC (ADMIN) -->
        <div class="tab-pane fade" id="pills-input">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card card-custom">
                        <div class="card-header-custom">üìù TH√äM C√îNG VI·ªÜC M·ªöI</div>
                        <div class="card-body p-4">
                            <form id="taskForm">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">T√™n c√¥ng vi·ªác <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="taskName" required placeholder="Nh·∫≠p t√™n ƒë·∫ßu vi·ªác...">
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                                    <select name="assignee" id="hiddenAssigneeSelect" multiple style="display:none"></select>
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center bg-white py-2" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                            <span id="selectedText" class="text-dark">-- Ch·ªçn nh√¢n s·ª± --</span>
                                            <span class="badge bg-success rounded-pill" id="selectedCount">0</span>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-custom shadow w-100" id="checkboxContainer"></div>
                                    </div>
                                </div>

                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Thu·ªôc T·ªï/B·ªô ph·∫≠n</label>
                                        <select class="form-select" name="group" id="groupSelect"></select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Ph√¢n lo·∫°i</label>
                                        <select class="form-select" name="taskType" id="taskTypeSelect" onchange="toggleDeadline()">
                                            <option value="Th∆∞·ªùng quy" selected>üü¶ Th∆∞·ªùng quy (Kh√¥ng g·∫•p)</option>
                                            <option value="C√≥ h·∫°n">üü• C√≥ Deadline (Quan tr·ªçng)</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">M·ª©c ƒë·ªô ∆Øu ti√™n</label>
                                        <select class="form-select" name="priority">
                                            <option value="P1">üî¥ Cao (Kh·∫©n c·∫•p)</option>
                                            <option value="P2" selected>üü° Trung b√¨nh</option>
                                            <option value="P3">üü¢ Th·∫•p</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">H·∫°n ch√≥t (Deadline)</label>
                                        <input type="date" class="form-control" name="deadline" id="deadlineInput">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Ghi ch√∫ / M√¥ t·∫£</label>
                                    <textarea class="form-control" name="notes" rows="3" placeholder="Chi ti·∫øt y√™u c·∫ßu..."></textarea>
                                </div>

                                <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm" id="submitBtn">
                                    üíæ L∆ØU C√îNG VI·ªÜC
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 4: N·ªòI QUY (ADMIN) -->
        <div class="tab-pane fade" id="pills-compliance">
             <div class="row g-4">
                <div class="col-md-4">
                    <div class="card card-custom h-100 border-0">
                        <div class="card-header bg-danger text-white fw-bold text-center">‚öñÔ∏è Ghi nh·∫≠n Vi ph·∫°m/Khen</div>
                        <div class="card-body">
                            <form id="complianceForm">
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Nh√¢n vi√™n</label>
                                    <select class="form-select" name="person" id="compliancePerson" required></select>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Lo·∫°i h√¨nh</label>
                                    <select class="form-select" name="type" required>
                                        <option value="Vi ph·∫°m">‚ö†Ô∏è Vi ph·∫°m</option>
                                        <option value="Khen th∆∞·ªüng">üèÜ Khen th∆∞·ªüng</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">N·ªôi dung chi ti·∫øt</label>
                                    <textarea class="form-control" name="fault" rows="4" required placeholder="M√¥ t·∫£ l·ªói ho·∫∑c th√†nh t√≠ch..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="fw-bold small mb-1">Ghi ch√∫ th√™m</label>
                                    <input type="text" class="form-control" name="note">
                                </div>
                                <button type="submit" class="btn btn-danger w-100 mt-2" id="btnCompliance">L∆∞u ghi nh·∫≠n</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card card-custom h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h6 class="fw-bold text-secondary m-0">üìú L·ªãch s·ª≠ Ghi nh·∫≠n</h6>
                            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="loadCompliance()">üîÑ T·∫£i l·∫°i</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px;">
                                <table class="table table-striped mb-0 table-custom">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th>Ng√†y</th>
                                            <th>Nh√¢n vi√™n</th>
                                            <th>Lo·∫°i</th>
                                            <th>N·ªôi dung</th>
                                            <th>Ghi ch√∫</th>
                                        </tr>
                                    </thead>
                                    <tbody id="complianceBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold text-primary">üîê ƒêƒÉng nh·∫≠p H·ªá th·ªëng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="fw-bold small mb-1">T√™n ƒëƒÉng nh·∫≠p (Username)</label>
                    <input type="text" id="loginUsername" class="form-control form-control-lg bg-light" placeholder="V√≠ d·ª•: thuongpb">
                </div>
                <div class="mb-4">
                    <label class="fw-bold small mb-1">M√£ PIN</label>
                    <input type="password" id="loginPin" class="form-control form-control-lg bg-light" placeholder="Nh·∫≠p PIN...">
                </div>
                <button type="button" class="btn btn-primary w-100 btn-lg fw-bold shadow-sm" onclick="performLogin()">ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>
</div>

<!-- Change PIN Modal -->
<div class="modal fade" id="changePinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header bg-light border-0">
                <h5 class="modal-title fw-bold">üîê ƒê·ªïi M√£ PIN</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3"><label class="fw-bold small">PIN C≈©:</label><input type="password" id="oldPin" class="form-control"></div>
                <div class="mb-3"><label class="fw-bold small">PIN M·ªõi:</label><input type="password" id="newPin" class="form-control"></div>
                <div class="mb-3"><label class="fw-bold small">Nh·∫≠p l·∫°i PIN M·ªõi:</label><input type="password" id="confirmPin" class="form-control"></div>
                <button type="button" class="btn btn-success w-100 fw-bold mt-3" onclick="submitChangePin()">X√°c nh·∫≠n ƒê·ªïi</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // URL Script Google Apps (GI·ªÆ NGUY√äN)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxK5MlsJWyH67Ckuwa48uctGPV-otNqg8a3vgyttWm6gIg_eInJt-JpUtB1VtF_Ah40Pw/exec"; 
    
    let globalData = [], globalCompliance = [], currentUser = null;

    const STAFF_GROUPS = {
        "Ban L√£nh ƒê·∫°o": ["Nguy·ªÖn Th·ªã H∆∞∆°ng Giang - Tr∆∞·ªüng Khoa", "Tr·∫ßn Th·ªã Huy·ªÅn Trang - Ph√≥ Khoa"],
        "D∆∞·ª£c sƒ©": ["Ph·∫°m B√° Th∆∞∆°ng", "L√™ Th·ªã Thanh Nh√†n", "Chu ƒê√†i Trang", "Nguy·ªÖn Duy Ti·∫øn", "Nguy·ªÖn Th·ªã H·∫±ng", "Ki·ªÅu M·∫°nh To√†n", "ƒê·ªó Th·ªã Nh·∫≠t L·ªá", "Nguy·ªÖn Th·ªã Thu H√†", "H√† Th·ªã Th·∫£o", "Nguy·ªÖn Tu·∫•n Th√†nh", "V≈© Th·ªã H·ªìng H·∫°nh", "H√† Thu Trang", "ƒêo√†n Th·ªã Mai H∆∞∆°ng", "Tri·ªáu Th·ªã V·ªµ"]
    };

    // --- KH·ªûI T·∫†O ---
    initUI(); 
    loadTaskList(); 
    checkSession();

    function initUI() { 
        initCheckboxes(); 
        initSingleSelect('compliancePerson');
        initGroupSelect(); 
        toggleDeadline(); 
        
        // M·∫∑c ƒë·ªãnh th√°ng hi·ªán t·∫°i cho b√°o c√°o
        const now = new Date();
        const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
        document.getElementById('reportMonthSelect').value = monthStr;
    }
    
    // --- X·ª¨ L√ù GIAO DI·ªÜN ---
    function toggleDeadline() {
        const typeSelect = document.getElementById('taskTypeSelect');
        const dlInput = document.getElementById('deadlineInput');
        if (typeSelect.value === 'Th∆∞·ªùng quy') {
            dlInput.value = ''; dlInput.disabled = true; dlInput.required = false; 
        } else {
            dlInput.disabled = false; dlInput.required = true; 
        }
    }

    function initGroupSelect() {
        const GROUP_LIST = ["T·ªï kho", "T·ªï D∆∞·ª£c l√¢m s√†ng", "T·ªï Trang thi·∫øt b·ªã", "T·ªï Th·ªëng k√™ v√† nghi·ªáp v·ª• d∆∞·ª£c", "T·ªï Truy·ªÅn th√¥ng", "T·ªï 5S", "T·ªï Cung ·ª©ng"];
        const s = document.getElementById('groupSelect');
        s.innerHTML = '<option value="">-- Ch·ªçn t·ªï --</option>';
        GROUP_LIST.forEach(group => { s.innerHTML += `<option value="${group}">${group}</option>`; });
        const f = document.getElementById('filterGroup');
        f.innerHTML = '<option value="">T·∫•t c·∫£</option>';
        GROUP_LIST.forEach(group => { f.innerHTML += `<option value="${group}">${group}</option>`; });
    }

    function initCheckboxes() { 
        const c = document.getElementById('checkboxContainer'); const h = document.getElementById('hiddenAssigneeSelect');
        const t = document.getElementById('selectedText'); const n = document.getElementById('selectedCount');
        c.innerHTML = ""; h.innerHTML = ""; 
        let allStaff = [];
        for(const [group, staffList] of Object.entries(STAFF_GROUPS)){ allStaff.push(...staffList); }
        allStaff = [...new Set(allStaff)];
        allStaff.forEach((name, i) => {
            h.add(new Option(name, name));
            const d = document.createElement('div'); d.className = 'person-item'; d.onclick = function(e) { e.stopPropagation(); }
            d.innerHTML = `<input class="form-check-input me-2" type="checkbox" value="${name}" id="chk${i}"><label class="w-100" for="chk${i}">${name}</label>`;
            c.appendChild(d);
            d.querySelector('input').addEventListener('change', (e) => { h.options[i].selected = e.target.checked; updateDisplay(h, t, n); });
        });
    }

    function updateDisplay(s,t,c){
        let cnt=0,nm=[]; 
        Array.from(s.options).forEach(o=>{if(o.selected){cnt++;nm.push(o.value)}});
        c.innerText=cnt;
        t.innerText=cnt===0?"-- Ch·ªçn nh√¢n s·ª± --":(cnt<=2?nm.join(", "):`ƒê√£ ch·ªçn ${cnt} ng∆∞·ªùi`);
        t.className = cnt>0 ? "text-primary fw-bold" : "text-muted";
    }

    function initSingleSelect(elId) { 
        const s=document.getElementById(elId); 
        s.innerHTML='<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>'; 
        for(const[g,ppl] of Object.entries(STAFF_GROUPS)){ 
            const o=document.createElement('optgroup'); o.label=g; 
            ppl.forEach(n=>o.innerHTML+=`<option value="${n}">${n}</option>`); 
            s.appendChild(o); 
        } 
    }

    // --- AUTHENTICATION ---
    function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    function performLogin() {
        const username = document.getElementById('loginUsername').value, pin = document.getElementById('loginPin').value;
        if(!username || !pin) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        fetch(SCRIPT_URL + "?action=login", { method: 'POST', body: JSON.stringify({ username, pin }) }).then(r => r.json()).then(res => {
            if(res.status === 'success') {
                currentUser = { username: res.username, name: res.name, role: res.role };
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                applyLoginState(); bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                alert(`üîì Xin ch√†o ${res.name}`); loadTaskList();
            } else alert("‚õî " + res.message);
        });
    }
    function logout() { sessionStorage.removeItem('user'); currentUser = null; applyLoginState(); location.reload(); }
    function checkSession() { const saved = sessionStorage.getItem('user'); if(saved) { currentUser = JSON.parse(saved); applyLoginState(); } }
    function applyLoginState() {
        const isLoggedIn = !!currentUser;
        document.getElementById('btnLogin').classList.toggle('d-none', isLoggedIn);
        document.getElementById('btnLogout').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('btnChangePin').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('userDisplay').innerText = isLoggedIn ? `üë§ ${currentUser.name}` : "Kh√°ch";
        const isAdmin = currentUser && currentUser.role === 'Admin';
        document.querySelectorAll('.admin-only').forEach(el => el.style.setProperty("display", isAdmin ? "block" : "none", "important"));
    }
    function showChangePinModal() { new bootstrap.Modal(document.getElementById('changePinModal')).show(); }
    function submitChangePin() {
        const oldPin = document.getElementById('oldPin').value, newPin = document.getElementById('newPin').value, confirmPin = document.getElementById('confirmPin').value;
        if(!oldPin || !newPin) return alert("Thi·∫øu th√¥ng tin!"); if(newPin !== confirmPin) return alert("PIN m·ªõi kh√¥ng kh·ªõp!");
        fetch(SCRIPT_URL + "?action=change_pin", { method: 'POST', body: JSON.stringify({ username: currentUser.username, oldPin, newPin }) }).then(r => r.json()).then(res => { alert(res.message); if(res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('changePinModal')).hide(); logout(); } });
    }

    // --- DANH S√ÅCH & RENDER ---
    function loadTaskList() { 
        document.getElementById('taskTableBody').innerHTML='<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-success"></div><div class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>'; 
        fetch(SCRIPT_URL).then(r=>r.json()).then(res=>{ globalData=res.data; populateFilter(); renderTable(); }); 
    }

    function renderTable() {
        const tb = document.getElementById('taskTableBody'); tb.innerHTML="";
        const fG = document.getElementById('filterGroup').value.toLowerCase().trim();
        const fN = document.getElementById('filterAssignee').value.toLowerCase().trim();
        const fS = document.getElementById('filterStatus').value;
        const fT = document.getElementById('filterText').value.toLowerCase().trim();
        const today = new Date(); today.setHours(0,0,0,0);
        
        let flt = globalData.filter(r => {
            let group = String(r[11] || "").toLowerCase();
            let as = String(r[7]).toLowerCase(), st = String(r[2]).trim(), nm = String(r[1]).toLowerCase();
            return (fG === "" || group.includes(fG)) && (fN === "" || as.includes(fN)) && (fS === "" || st.toLowerCase() === fS.toLowerCase()) && (fT === "" || nm.includes(fT));
        });
        
        // Sort: Group -> Done/Todo -> Date
        flt.sort((a, b) => {
            const grpA = (a[11] || "").toLowerCase(), grpB = (b[11] || "").toLowerCase(); if (grpA < grpB) return -1; if (grpA > grpB) return 1;
            const statusA = String(a[2]).trim(), statusB = String(b[2]).trim();
            const doneA = statusA === 'Done', doneB = statusB === 'Done'; if (doneA && !doneB) return 1; if (!doneA && doneB) return -1;
            const dateA = new Date(a[9] || a[4] || '9999-12-31'); const dateB = new Date(b[9] || b[4] || '9999-12-31'); return dateA - dateB;
        });
        
        if(flt.length === 0) { tb.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác n√†o.</td></tr>'; return; }

        flt.forEach(r => {
            let id = r[0], name = r[1], status = String(r[2]).trim(), assignee = r[7];
            let type = r[10] || "Th∆∞·ªùng quy", group = r[11] || ""; 
            let dlRaw = r[9] || r[4], dlDisp = dlRaw ? new Date(dlRaw).toLocaleDateString('vi-VN') : '';
            let prog = parseProgress(r[8]);
            
            let isOwner = currentUser && (currentUser.role === 'Admin' || assignee.includes(currentUser.name));
            let disableControl = isOwner ? "" : "pointer-events: none; opacity: 0.6;";
            
            let isOverdue = false;
            if (dlRaw && new Date(dlRaw) < today && status !== 'Done') isOverdue = true;

            // HTML Elements
            let badgeClass = status === 'Done' ? 'bg-done' : (isOverdue ? 'bg-overdue' : (status === 'Doing' ? 'bg-doing' : 'bg-todo'));
            let statusText = isOverdue ? 'Qu√° h·∫°n' : (status==='Todo'?'Ch∆∞a l√†m':status);
            
            let dlHtml = dlDisp;
            if (r[9] && r[9] !== r[4]) dlHtml = `<span class="deadline-original">${new Date(r[4]).toLocaleDateString('vi-VN')}</span><br><span class="deadline-extended">‚Ü≥ ${dlDisp}</span>`;
            if (isOverdue) dlHtml = `<span class="text-danger fw-bold">‚ö†Ô∏è ${dlHtml}</span>`;

            let slider = status === 'Done' 
                ? `<div class="progress" style="height:8px;"><div class="progress-bar bg-success" style="width:100%"></div></div><small class="text-success fw-bold">100%</small>` 
                : `<div class="d-flex align-items-center" style="${disableControl}"><input type="range" class="form-range me-2" style="width:80px" min="0" max="100" step="10" value="${prog}" onchange="updateProgress('${id}',this.value)"><span class="badge bg-light text-dark border" id="val-${id}">${prog}%</span></div>`;

            let actionBtns = status !== 'Done' 
                ? `<div class="btn-action-group" style="${disableControl}">
                    <button class="btn btn-sm btn-outline-success w-100 mb-1" onclick="markDone('${id}')" title="Ho√†n th√†nh">‚úÖ Xong</button>
                    <button class="btn btn-sm btn-outline-warning w-100 text-dark" onclick="sendEmailBackend('${id}','${name}','${assignee}','${dlRaw}')" title="G·ª≠i mail nh·∫Øc">üìß Nh·∫Øc</button>
                   </div>` 
                : '<span class="text-success fw-bold">‚úî Ho√†n t·∫•t</span>';

            let groupBadge = group ? `<span class="badge bg-secondary mb-1" style="font-size:0.7em">${group}</span><br>` : '';

            tb.innerHTML += `
            <tr class="${isOverdue ? 'table-danger' : ''}">
                <td>
                    ${groupBadge}
                    <span class="fw-bold text-dark">${name}</span>
                    <div class="text-muted small mt-1"><em>${r[5] || ''}</em></div>
                </td>
                <td>${slider}</td>
                <td><small class="fw-bold text-primary">${assignee}</small></td>
                <td class="small">${dlHtml}</td>
                <td><span class="badge badge-status ${badgeClass}">${statusText}</span></td>
                <td class="text-center">${actionBtns}</td>
            </tr>`;
        });
    }
    
    // --- HELPER FUNCTIONS ---
    function parseProgress(val) { if(!val)return 0; let s=String(val).replace(/^'/,'').replace('%','').trim(); let n=parseFloat(s); return isNaN(n)?0:(n<=1&&n>0&&s.includes('.')?Math.round(n*100):Math.round(n)); }
    function populateFilter() { 
        const s = document.getElementById('filterAssignee'); s.innerHTML = '<option value="">T·∫•t c·∫£</option>'; 
        let a = []; globalData.forEach(r => a.push(...String(r[7]).split(',').map(v => v.trim()).filter(v => v))); 
        [...new Set(a)].sort().forEach(n => s.innerHTML += `<option value="${n}">${n}</option>`); 
    }

    // --- ACTIONS ---
    function updateProgress(id, v) { 
        if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); 
        document.getElementById(`val-${id}`).innerText=v+'%'; 
        fetch(SCRIPT_URL+"?action=update_progress",{method:'POST',body:JSON.stringify({id:id,progress:v, user_fullname: currentUser.name, role: currentUser.role})})
        .then(r=>r.json()).then(res=>{if(res.status==='error'){alert(res.message); loadTaskList();} else if(v==100)loadTaskList()}); 
    }
    
    function markDone(id) { 
        if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); 
        if(confirm('X√°c nh·∫≠n ho√†n th√†nh c√¥ng vi·ªác?')) 
            fetch(SCRIPT_URL+"?action=update",{method:'POST',body:JSON.stringify({id:id, user_fullname: currentUser.name, role: currentUser.role})}).then(r=>r.json()).then(res=>{alert(res.message);loadTaskList()}); 
    }
    
    function sendEmailBackend(id,t,p,d){ 
        if(!confirm(`G·ª≠i mail nh·∫Øc nh·ªü cho ${p}?`))return; 
        let dl=d?new Date(d).toLocaleDateString('vi-VN'):'S·ªõm nh·∫•t'; 
        const btn=event.target; const txt=btn.innerText; btn.innerText="‚è≥..."; btn.disabled=true; 
        fetch(SCRIPT_URL+"?action=send_email_manual",{method:'POST',body:JSON.stringify({taskName:t,assignee:p,deadline:dl})})
        .then(r=>r.json()).then(res=>{alert(res.message)}).finally(()=>{btn.innerText=txt;btn.disabled=false}); 
    }
    
    function triggerBulkEmail() { 
        if(!currentUser || currentUser.role !== 'Admin') return alert("‚õî Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn n√†y!"); 
        const pending=globalData.filter(r=>String(r[2]).trim()!=='Done'); 
        if(pending.length===0) return alert("Kh√¥ng c√≥ vi·ªác c·∫ßn g·ª≠i!"); 
        if(!confirm(`G·ª≠i mail nh·∫Øc vi·ªác cho ${pending.length} ƒë·∫ßu vi·ªác ch∆∞a xong?`))return; 
        const btn=event.target;const t=btn.innerText;btn.innerText="‚è≥ G·ª≠i...";btn.disabled=true; 
        fetch(SCRIPT_URL+"?action=send_bulk_email",{method:'POST',body:JSON.stringify({taskIds:pending.map(r=>r[0]),sender:currentUser.name})})
        .then(r=>r.json()).then(res=>alert(res.message)).finally(()=>{btn.innerText=t;btn.disabled=false}); 
    }

    // --- FORM SUBMIT ---
    document.getElementById('taskForm').addEventListener('submit', e => { 
        e.preventDefault(); 
        if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} 
        const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerText = "‚è≥ ƒêang l∆∞u...";
        const d=Object.fromEntries(new FormData(e.target).entries()); 
        d.assignee=Array.from(document.getElementById('hiddenAssigneeSelect').selectedOptions).map(o=>o.value).join(', '); 
        d.role=currentUser.role; 
        fetch(SCRIPT_URL+"?action=add",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ 
            alert(res.message); 
            if(res.status==='success'){
                e.target.reset(); 
                document.querySelectorAll('#checkboxContainer input').forEach(c=>c.checked=false); 
                updateDisplay(document.getElementById('hiddenAssigneeSelect'),document.getElementById('selectedText'),document.getElementById('selectedCount')); 
                document.querySelector('[data-bs-target="#pills-list"]').click(); 
                loadTaskList();
            } 
        }).finally(()=>{btn.disabled=false; btn.innerText = "üíæ L∆ØU C√îNG VI·ªÜC";}); 
    });

    document.getElementById('complianceForm').addEventListener('submit', e => { 
        e.preventDefault(); 
        if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} 
        const btn=document.getElementById('btnCompliance'); btn.disabled=true; 
        const d=Object.fromEntries(new FormData(e.target).entries()); d.role=currentUser.role; 
        fetch(SCRIPT_URL+"?action=add_compliance",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ 
            alert(res.message); if(res.status==='success'){e.target.reset(); loadCompliance();} 
        }).finally(()=>{btn.disabled=false;}); 
    });

    // --- COMPLIANCE ---
    function loadCompliance(){
        const tb=document.getElementById('complianceBody');tb.innerHTML='<tr><td colspan="5" class="text-center">Loading...</td></tr>'; 
        fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json()).then(res=>{ 
            globalCompliance = res.data || []; 
            tb.innerHTML=""; 
            if(!res.data||!res.data.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';return;} 
            res.data.reverse().forEach(r=>{ 
                let h=r.length>=6,t=h?r[3]:(r[3].includes("Khen")?"Khen th∆∞·ªüng":"Vi ph·∫°m"),c=h?r[4]:r[3],n=h?r[5]:r[4];
                let b=t.includes("Khen")?'<span class="badge bg-warning text-dark">üèÜ Khen th∆∞·ªüng</span>':'<span class="badge bg-danger">‚ö†Ô∏è Vi ph·∫°m</span>'; 
                tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString('vi-VN')}</td><td class="fw-bold">${r[2]}</td><td>${b}</td><td>${c}</td><td>${n||''}</td></tr>`; 
            }); 
        }); 
    }

    // --- CHARTS & REPORT ---
    google.charts.load('current',{'packages':['corechart','bar']});

    function loadDashboard() { 
        if(SCRIPT_URL.includes("D√ÅN_LINK")) return; 
        document.getElementById('calendar').innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';
        Promise.all([
            fetch(SCRIPT_URL).then(r=>r.json()), 
            fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json())
        ]).then(([taskRes, compRes]) => { 
            globalData = taskRes.data || [];
            globalCompliance = compRes.data || [];
            updateReport(); 
        }); 
    }

    function updateReport() {
        const monthStr = document.getElementById('reportMonthSelect').value; 
        if (!monthStr) return;
        const [year, month] = monthStr.split('-').map(Number);
        const startOfMonth = new Date(year, month - 1, 1);
        const endOfMonth = new Date(year, month, 0, 23, 59, 59);
        const today = new Date(); today.setHours(0,0,0,0);

        // Filter Logic
        const filteredTasks = globalData.filter(r => {
            const created = new Date(r[6]);
            let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date());
            return created <= endOfMonth && deadline >= startOfMonth;
        });
        const filteredCompliance = globalCompliance.filter(r => {
            const date = new Date(r[1]); return date >= startOfMonth && date <= endOfMonth;
        });

        drawCharts(filteredTasks, filteredCompliance);
        renderCal(filteredTasks, filteredCompliance, today);
    }

    function drawCharts(t,c) { 
        var stats = {'Done': 0, 'Doing': 0, 'Overdue': 0};
        var p = {}; 
        var today = new Date(); today.setHours(0,0,0,0);

        t.forEach(r => {
            let status = String(r[2]).trim();
            let dlRaw = r[9] || r[4];
            let dl = dlRaw ? new Date(dlRaw) : null;
            let isOverdue = (status !== 'Done' && dl && dl < today);

            String(r[7]).split(',').forEach(n=>{ 
                n=n.trim(); 
                if(n){ 
                    if(!p[n]) p[n] = { done: 0, overdue: 0, normal: 0 };
                    if (status === 'Done') p[n].done++;
                    else if (isOverdue) p[n].overdue++;
                    else p[n].normal++;
                }
            });

            if (status === 'Done') stats.Done++;
            else if (isOverdue) stats.Overdue++;
            else stats.Doing++;
        }); 
        
        var pieData = google.visualization.arrayToDataTable([
            ['Tr·∫°ng th√°i', 'S·ªë l∆∞·ª£ng'],
            ['ƒê√£ xong', stats.Done],
            ['ƒêang l√†m', stats.Doing],
            ['Qu√° h·∫°n', stats.Overdue]
        ]);
        new google.visualization.PieChart(document.getElementById('piechart_task')).draw(pieData, {
            colors: ['#198754', '#0dcaf0', '#dc3545'], is3D: false, pieHole: 0.4, legend: {position: 'bottom'}, chartArea:{width:'90%',height:'80%'}
        }); 
        
        var arr = [['Nh√¢n vi√™n', 'ƒê√£ xong', 'ƒêang l√†m', 'Qu√° h·∫°n']];
        Object.keys(p).sort().forEach(k => { arr.push([k, p[k].done, p[k].normal, p[k].overdue]); });
        if(arr.length > 1) {
            new google.visualization.ColumnChart(document.getElementById('barchart_task')).draw(google.visualization.arrayToDataTable(arr),{
                isStacked: true, colors: ['#198754', '#0dcaf0', '#dc3545'], legend: { position: 'bottom' }, chartArea: {width:'85%', height:'70%'}
            }); 
        }

        // Compliance Charts
        var pc={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pc[n])pc[n]=0;if(!tp.includes("Khen"))pc[n]++;}); 
        var ac=[['NV','Vi ph·∫°m',{role:"style"}]]; Object.keys(pc).sort().forEach(k=>{if(pc[k]>0)ac.push([k,pc[k],'#dc3545']);}); 
        if(ac.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_violation')).draw(google.visualization.arrayToDataTable(ac),{legend:'none',chartArea:{width:'85%',height:'70%'}}); 
        else document.getElementById('columnchart_violation').innerHTML="<div class='d-flex align-items-center justify-content-center h-100 text-muted'>Tr·ªëng</div>";
        
        var pr={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pr[n])pr[n]=0;if(tp.includes("Khen"))pr[n]++;}); 
        var ar=[['NV','Khen th∆∞·ªüng',{role:"style"}]]; Object.keys(pr).sort().forEach(k=>{if(pr[k]>0)ar.push([k,pr[k],'#ffc107']);}); 
        if(ar.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_reward')).draw(google.visualization.arrayToDataTable(ar),{legend:'none',chartArea:{width:'85%',height:'70%'}});
        else document.getElementById('columnchart_reward').innerHTML="<div class='d-flex align-items-center justify-content-center h-100 text-muted'>Tr·ªëng</div>";
    }

    // üî• LOGIC L·ªäCH M·ªöI: M√†u s·∫Øc theo Deadline
    function renderCal(t, c, today) { 
        var ev=[]; 
        
        t.forEach(r => {
            let dlRaw = r[9]||r[4];
            if(!dlRaw) return; // B·ªè qua n·∫øu kh√¥ng c√≥ deadline
            
            let status = String(r[2]).trim();
            let dlDate = new Date(dlRaw);
            let isOverdue = (dlDate < today && status !== 'Done');
            
            // Logic m√†u s·∫Øc
            let bgColor, borderColor;
            if (status === 'Done') {
                bgColor = '#198754'; // Xanh l√°
                borderColor = '#198754';
            } else if (isOverdue) {
                bgColor = '#dc3545'; // ƒê·ªè (Qu√° h·∫°n)
                borderColor = '#dc3545';
            } else {
                bgColor = '#0d6efd'; // Xanh d∆∞∆°ng (S·∫Øp t·ªõi)
                borderColor = '#0d6efd';
            }

            ev.push({
                title: `${status === 'Done' ? '‚úî' : (isOverdue ? '‚ö†Ô∏è' : '‚è≥')} ${r[1]} (${r[7]})`,
                start: dlDate.toISOString().split('T')[0],
                backgroundColor: bgColor,
                borderColor: borderColor,
                textColor: 'white',
                extendedProps: {
                    description: `Tr·∫°ng th√°i: ${status}\nGhi ch√∫: ${r[5]||'Kh√¥ng'}`
                }
            });
        }); 

        c.forEach(r => {
            if(!r[1]) return;
            let h=r.length>=6, tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");
            let isReward = tp.includes("Khen");
            ev.push({
                title: isReward ? `üèÜ ${r[2]}` : `‚õî ${r[2]}`,
                start: new Date(r[1]).toISOString().split('T')[0],
                backgroundColor: isReward ? '#ffc107' : '#212529',
                borderColor: isReward ? '#ffc107' : '#212529',
                textColor: isReward ? 'black' : 'white',
                extendedProps: { description: h ? r[4] : r[3] }
            });
        }); 

        var calEl = document.getElementById('calendar');
        calEl.innerHTML = ""; // Clear c≈©
        var cal = new FullCalendar.Calendar(calEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            height: 'auto',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listMonth'
            },
            buttonText: {
                today: 'H√¥m nay',
                month: 'L·ªãch th√°ng',
                list: 'Danh s√°ch'
            },
            events: ev,
            eventClick: function(i) {
                alert(`üìå ${i.event.title}\n‚ÑπÔ∏è ${i.event.extendedProps.description || ''}`);
            }
        }); 
        cal.render(); 
    }

    function exportExcelReport() {
        const monthStr = document.getElementById('reportMonthSelect').value;
        const [year, month] = monthStr.split('-').map(Number);
        const startOfMonth = new Date(year, month - 1, 1);
        const endOfMonth = new Date(year, month, 0, 23, 59, 59);

        const taskData = globalData
            .filter(r => {
                const created = new Date(r[6]);
                let deadline = r[9] ? new Date(r[9]) : (r[4] ? new Date(r[4]) : new Date());
                return created <= endOfMonth && deadline >= startOfMonth;
            })
            .map(r => ({
                "T√™n c√¥ng vi·ªác": r[1],
                "T·ªï": r[11] || "",
                "Ng∆∞·ªùi th·ª±c hi·ªán": r[7],
                "Tr·∫°ng th√°i": r[2],
                "Ng√†y t·∫°o": new Date(r[6]).toLocaleDateString('vi-VN'),
                "Deadline": r[9] ? new Date(r[9]).toLocaleDateString('vi-VN') : (r[4] ? new Date(r[4]).toLocaleDateString('vi-VN') : ""),
                "Ti·∫øn ƒë·ªô": r[8] + "%",
                "Ghi ch√∫": r[5]
            }));

        const complianceData = globalCompliance
            .filter(r => {
                const date = new Date(r[1]); return date >= startOfMonth && date <= endOfMonth;
            })
            .map(r => {
                let h=r.length>=6;
                return {
                    "Ng√†y": new Date(r[1]).toLocaleDateString('vi-VN'),
                    "Nh√¢n vi√™n": r[2],
                    "Lo·∫°i": h?r[3]:(r[3].includes("Khen")?"Khen th∆∞·ªüng":"Vi ph·∫°m"),
                    "N·ªôi dung": h?r[4]:r[3],
                    "Ghi ch√∫": h?r[5]:r[4]
                };
            });

        const wb = XLSX.utils.book_new();
        if (taskData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(taskData), "CongViec");
        else XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{"Note": "Kh√¥ng c√≥ d·ªØ li·ªáu"}]), "CongViec");
        
        if (complianceData.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(complianceData), "NoiQuy");
        
        XLSX.writeFile(wb, `BaoCao_KhoaDuoc_${monthStr}.xlsx`);
    }
</script>
</body>
</html>

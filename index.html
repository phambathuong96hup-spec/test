<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Khoa D∆∞·ª£c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    
    <style>
        :root { --primary-color: #0f9d58; --bg-color: #f0f2f5; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        .nav-pills .nav-link.active { background-color: var(--primary-color); color: white; box-shadow: 0 4px 6px rgba(15, 157, 88, 0.3); }
        .nav-pills .nav-link { color: #555; font-weight: 600; cursor: pointer;}
        .card-custom { border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-radius: 12px; background: white; }
        .badge-status { font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; }
        .bg-todo { background-color: #dc3545; color: white; } .bg-doing { background-color: #ffc107; color: #333; } .bg-done { background-color: #198754; color: white; }
        .disabled-control { pointer-events: none; opacity: 0.5; filter: grayscale(100%); }
        .admin-only, .logged-only { display: none !important; }
        .range-slider { width: 100%; cursor: pointer; height: 8px; accent-color: var(--primary-color); }
        .btn-action { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; width: 100%; text-align: left; margin-bottom: 4px; border-radius: 4px; border: none; transition: 0.2s; }
        .btn-email { background-color: #fff3cd; color: #856404; } .btn-email:hover { background-color: #ffeeba; }
        .deadline-extended { color: #dc3545; font-weight: bold; }
        .deadline-original { text-decoration: line-through; color: #999; font-size: 0.85em; display: block; }
        .dropdown-menu-custom { max-height: 300px; overflow-y: auto; width: 100%; padding: 0; }
        .group-header { background-color: #e9ecef; padding: 6px 15px; font-weight: bold; color: #495057; font-size: 0.85rem; border-bottom: 1px solid #ddd; }
        .form-check { padding: 8px 15px 8px 40px; margin: 0; cursor: pointer; border-bottom: 1px solid #f8f9fa; }
        .form-check:hover { background-color: #f1f3f5; }
        .form-check-input { cursor: pointer; transform: scale(1.2); margin-left: -25px; }
        #hiddenAssigneeSelect { display: none; }
        
        /* Style cho lo·∫°i c√¥ng vi·ªác */
        .type-routine { border-left: 4px solid #adb5bd; }
        .type-deadline { border-left: 4px solid #dc3545; background-color: #fffbfb; }
        .group-tag { font-size: 0.75rem; background: #e9ecef; padding: 2px 6px; border-radius: 4px; color: #495057; display: inline-block; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-success fw-bold m-0">üè• QU·∫¢N L√ù KHOA D∆Ø·ª¢C</h3>
        <div>
            <span id="userDisplay" class="me-2 fw-bold text-primary"></span>
            <button class="btn btn-outline-secondary btn-sm d-none me-1" id="btnChangePin" onclick="showChangePinModal()">üîê ƒê·ªïi PIN</button>
            <button class="btn btn-outline-dark btn-sm" id="btnLogin" onclick="showLoginModal()">üë§ ƒêƒÉng nh·∫≠p</button>
            <button class="btn btn-outline-danger btn-sm d-none" id="btnLogout" onclick="logout()">üö™ Tho√°t</button>
        </div>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
        <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-input">üìù Giao Vi·ªác</button></li>
        <li class="nav-item admin-only"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-compliance">‚öñÔ∏è N·ªôi Quy</button></li>
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-list" onclick="loadTaskList()">üìã Danh S√°ch</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-report" onclick="loadDashboard()">üìä B√°o C√°o</button></li>
    </ul>

    <div class="tab-content">
        <!-- TAB GIAO VI·ªÜC -->
        <div class="tab-pane fade" id="pills-input">
            <div class="container" style="max-width: 900px;">
                <div class="card card-custom p-4">
                    <form id="taskForm">
                        <div class="mb-3"><label class="fw-bold">T√™n c√¥ng vi·ªác</label><input type="text" class="form-control" name="taskName" required></div>
                        
                        <!-- CH·ªåN NG∆Ø·ªúI L√ÄM -->
                        <div class="mb-3">
                            <label class="fw-bold">Ng∆∞·ªùi th·ª±c hi·ªán</label>
                            <select name="assignee" id="hiddenAssigneeSelect" multiple></select>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                    <span id="selectedText">-- Ch·ªçn nh√¢n s·ª± --</span><span class="badge bg-success rounded-pill" id="selectedCount">0</span>
                                </button>
                                <div class="dropdown-menu dropdown-menu-custom shadow" id="checkboxContainer"></div>
                            </div>
                        </div>

                        <!-- CH·ªåN T·ªî & PH√ÇN LO·∫†I -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold">Thu·ªôc T·ªï/B·ªô ph·∫≠n</label>
                                <select class="form-select" name="group" id="groupSelect">
                                    <!-- S·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông t·ª´ JS -->
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="fw-bold">Ph√¢n lo·∫°i c√¥ng vi·ªác</label>
                                <select class="form-select" name="taskType">
                                    <option value="Th∆∞·ªùng quy" selected>üü¶ C√¥ng vi·ªác Th∆∞·ªùng quy</option>
                                    <option value="C√≥ h·∫°n">üü• C√¥ng vi·ªác C√≥ h·∫°n (Deadline)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="fw-bold">M·ª©c ƒë·ªô ∆Øu ti√™n</label><select class="form-select" name="priority"><option value="P1">üî¥ Cao</option><option value="P2" selected>üü° Trung b√¨nh</option><option value="P3">üü¢ Th·∫•p</option></select></div>
                            <div class="col-md-6 mb-3"><label class="fw-bold">Deadline (H·∫°n ch√≥t)</label><input type="date" class="form-control" name="deadline" required></div>
                        </div>

                        <div class="mb-3"><textarea class="form-control" name="notes" rows="2" placeholder="Ghi ch√∫ chi ti·∫øt..."></textarea></div>
                        
                        <button type="submit" class="btn btn-success w-100 fw-bold" id="submitBtn">üíæ L∆ØU C√îNG VI·ªÜC</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- TAB DANH S√ÅCH -->
        <div class="tab-pane fade show active" id="pills-list">
            <div class="card card-custom p-4">
                <div class="row g-2 mb-3">
                    <div class="col-md-3"><select id="filterAssignee" class="form-select form-select-sm" onchange="renderTable()"><option value="">NV: T·∫•t c·∫£</option></select></div>
                    <div class="col-md-3"><select id="filterStatus" class="form-select form-select-sm" onchange="renderTable()"><option value="">TT: T·∫•t c·∫£</option><option value="Todo">Todo (Ch∆∞a xong)</option><option value="Done">Done (Xong)</option></select></div>
                    <div class="col-md-3"><input type="text" id="filterText" class="form-control form-control-sm" placeholder="T√¨m t√™n vi·ªác..." onkeyup="renderTable()"></div>
                    
                    <!-- N√∫t G·ª≠i Email ƒê·ªìng Lo·∫°t -->
                    <div class="col-md-3 d-flex gap-1">
                        <button class="btn btn-warning btn-sm fw-bold w-100 admin-only" onclick="triggerBulkEmail()" title="G·ª≠i mail cho t·∫•t c·∫£ vi·ªác ch∆∞a xong">üìß G·ª≠i mail lo·∫°t</button>
                        <button class="btn btn-primary btn-sm w-50" onclick="loadTaskList()">üîÑ T·∫£i</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle border">
                        <thead class="table-success">
                            <tr>
                                <th width="30%">C√¥ng vi·ªác / T·ªï</th>
                                <th width="20%">Ti·∫øn ƒë·ªô</th>
                                <th width="15%">Ng∆∞·ªùi l√†m</th>
                                <th width="10%">Deadline</th>
                                <th width="10%">Tr·∫°ng th√°i</th>
                                <th width="10%">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="taskTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB N·ªòI QUY -->
        <div class="tab-pane fade" id="pills-compliance">
             <div class="row g-4">
                <div class="col-md-4">
                    <div class="card card-custom p-3 h-100">
                        <h5 class="text-danger fw-bold text-center">‚öñÔ∏è Ghi nh·∫≠n Vi ph·∫°m/Khen</h5>
                        <form id="complianceForm">
                            <div class="mb-2"><label class="fw-bold small">Nh√¢n vi√™n</label><select class="form-select" name="person" id="compliancePerson" required></select></div>
                            <div class="mb-2"><label class="fw-bold small">Lo·∫°i</label><select class="form-select" name="type" required><option value="Vi ph·∫°m">‚ö†Ô∏è Vi ph·∫°m</option><option value="Khen th∆∞·ªüng">üèÜ Khen th∆∞·ªüng</option></select></div>
                            <div class="mb-2"><label class="fw-bold small">N·ªôi dung</label><textarea class="form-control" name="fault" rows="3" required></textarea></div>
                            <div class="mb-3"><label class="fw-bold small">Ghi ch√∫</label><input type="text" class="form-control" name="note"></div>
                            <button type="submit" class="btn btn-danger w-100" id="btnCompliance">L∆∞u ghi nh·∫≠n</button>
                        </form>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card card-custom p-3 h-100">
                        <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold text-secondary">üìú L·ªãch s·ª≠</h5><button class="btn btn-sm btn-outline-secondary" onclick="loadCompliance()">üîÑ T·∫£i l·∫°i</button></div>
                        <div class="table-responsive"><table class="table table-sm table-striped"><thead class="table-light"><tr><th>Ng√†y</th><th>Nh√¢n vi√™n</th><th>Lo·∫°i</th><th>N·ªôi dung</th><th>Ghi ch√∫</th></tr></thead><tbody id="complianceBody"></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB B√ÅO C√ÅO -->
        <div class="tab-pane fade" id="pills-report">
             <div class="row g-4 mb-4">
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-secondary">üìä T·ªâ l·ªá ho√†n th√†nh</h6><div id="piechart_task" style="height:300px;"></div></div></div>
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-secondary">üìà S·ªë l∆∞·ª£ng c√¥ng vi·ªác</h6><div id="barchart_task" style="height:300px;"></div></div></div>
            </div>
            <div class="row g-4 mb-4">
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-danger">‚ö†Ô∏è Vi ph·∫°m</h6><div id="columnchart_violation" style="height:300px;"></div></div></div>
                <div class="col-md-6"><div class="card card-custom p-3 h-100"><h6 class="text-center fw-bold text-warning">üèÜ Khen th∆∞·ªüng</h6><div id="columnchart_reward" style="height:300px;"></div></div></div>
            </div>
            <div class="card card-custom p-4"><h5 class="text-success fw-bold mb-3">üìÖ L·ªäCH T·ªîNG H·ª¢P</h5><div id="calendar"></div></div>
        </div>
    </div>
</div>

<!-- Login & Pin Modals -->
<div class="modal fade" id="loginModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">üîê ƒêƒÉng nh·∫≠p</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <div class="mb-3"><label class="fw-bold">T√™n ƒëƒÉng nh·∫≠p:</label><input type="text" id="loginUsername" class="form-control" placeholder="V√≠ d·ª•: thuongpb"></div>
    <div class="mb-3"><label class="fw-bold">M√£ PIN:</label><input type="password" id="loginPin" class="form-control" placeholder="Nh·∫≠p PIN..."></div>
</div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="performLogin()">ƒêƒÉng nh·∫≠p</button></div></div></div></div>

<div class="modal fade" id="changePinModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">üîê ƒê·ªïi M√£ PIN</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="fw-bold">PIN C≈©:</label><input type="password" id="oldPin" class="form-control"></div><div class="mb-3"><label class="fw-bold">PIN M·ªõi:</label><input type="password" id="newPin" class="form-control"></div><div class="mb-3"><label class="fw-bold">Nh·∫≠p l·∫°i PIN M·ªõi:</label><input type="password" id="confirmPin" class="form-control"></div></div><div class="modal-footer"><button type="button" class="btn btn-success w-100" onclick="submitChangePin()">X√°c nh·∫≠n ƒê·ªïi</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpNQd8Q7FR8nCkos4CuvLyz93K4oav4RZYMMNXPJW3Tri2Z3TGDiqPGK-yDkZjvaJBFA/exec"; // ‚ö†Ô∏è Nh·ªõ update link m·ªõi sau khi Deploy
    let globalData = [], currentUser = null;

    // --- DANH S√ÅCH T·ªî V√Ä NH√ÇN VI√äN ---
    const STAFF_GROUPS = {
        "Ban L√£nh ƒê·∫°o": ["Nguy·ªÖn Th·ªã H∆∞∆°ng Giang - Tr∆∞·ªüng Khoa", "Tr·∫ßn Th·ªã Huy·ªÅn Trang - Ph√≥ Khoa"],
        "T·ªï L√¢m S√†ng": ["Ph·∫°m B√° Th∆∞∆°ng", "L√™ Th·ªã Thanh Nh√†n", "Chu ƒê√†i Trang"],
        "T·ªï Kho": ["Nguy·ªÖn Duy Ti·∫øn", "Nguy·ªÖn Th·ªã H·∫±ng", "Ki·ªÅu M·∫°nh To√†n", "ƒê·ªó Th·ªã Nh·∫≠t L·ªá"],
        "T·ªï Nghi·ªáp V·ª•": ["Nguy·ªÖn Th·ªã Thu H√†", "H√† Th·ªã Th·∫£o", "Nguy·ªÖn Tu·∫•n Th√†nh"],
        "Nh√† Thu·ªëc": ["V≈© Th·ªã H·ªìng H·∫°nh", "H√† Thu Trang", "ƒêo√†n Th·ªã Mai H∆∞∆°ng", "Tri·ªáu Th·ªã V·ªµ"]
    };

    initUI(); loadTaskList(); checkSession();

    function initUI() { 
        initCheckboxes(); 
        initSingleSelect('compliancePerson');
        initGroupSelect(); // Kh·ªüi t·∫°o dropdown ch·ªçn t·ªï
    }
    
    // T·∫°o dropdown ch·ªçn T·ªï cho form Giao vi·ªác
    function initGroupSelect() {
        const s = document.getElementById('groupSelect');
        s.innerHTML = '<option value="">-- Ch·ªçn t·ªï --</option>';
        Object.keys(STAFF_GROUPS).forEach(group => {
            s.innerHTML += `<option value="${group}">${group}</option>`;
        });
    }

    // --- C√ÅC H√ÄM LOGIN / PIN ---
    function showLoginModal() { new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    function performLogin() {
        const username = document.getElementById('loginUsername').value;
        const pin = document.getElementById('loginPin').value;
        if(!username || !pin) return alert("Thi·∫øu th√¥ng tin!");
        fetch(SCRIPT_URL + "?action=login", { method: 'POST', body: JSON.stringify({ username, pin }) })
        .then(r => r.json()).then(res => {
            if(res.status === 'success') {
                currentUser = { username: res.username, name: res.name, role: res.role };
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                applyLoginState();
                bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
                alert(`üîì Xin ch√†o ${res.name}`);
                loadTaskList();
            } else alert("‚õî " + res.message);
        });
    }
    function logout() { sessionStorage.removeItem('user'); currentUser = null; applyLoginState(); location.reload(); }
    function checkSession() { const saved = sessionStorage.getItem('user'); if(saved) { currentUser = JSON.parse(saved); applyLoginState(); } }
    function applyLoginState() {
        const isLoggedIn = !!currentUser;
        document.getElementById('btnLogin').classList.toggle('d-none', isLoggedIn);
        document.getElementById('btnLogout').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('btnChangePin').classList.toggle('d-none', !isLoggedIn);
        document.getElementById('userDisplay').innerText = isLoggedIn ? `üë§ ${currentUser.name}` : "";
        const isAdmin = currentUser && currentUser.role === 'Admin';
        document.querySelectorAll('.admin-only').forEach(el => el.style.setProperty("display", isAdmin ? "block" : "none", "important"));
    }
    function showChangePinModal() { new bootstrap.Modal(document.getElementById('changePinModal')).show(); }
    function submitChangePin() {
        const oldPin = document.getElementById('oldPin').value, newPin = document.getElementById('newPin').value, confirmPin = document.getElementById('confirmPin').value;
        if(!oldPin || !newPin) return alert("Thi·∫øu th√¥ng tin!");
        if(newPin !== confirmPin) return alert("PIN m·ªõi kh√¥ng kh·ªõp!");
        fetch(SCRIPT_URL + "?action=change_pin", { method: 'POST', body: JSON.stringify({ username: currentUser.username, oldPin, newPin }) })
        .then(r => r.json()).then(res => { alert(res.message); if(res.status === 'success') { bootstrap.Modal.getInstance(document.getElementById('changePinModal')).hide(); logout(); } });
    }

    // --- RENDER TABLE (S·∫ÆP X·∫æP TH√îNG MINH) ---
    function renderTable() {
        const tb = document.getElementById('taskTableBody'); tb.innerHTML="";
        const fN = document.getElementById('filterAssignee').value.toLowerCase().trim();
        const fS = document.getElementById('filterStatus').value;
        const fT = document.getElementById('filterText').value.toLowerCase().trim();
        
        let flt = globalData.filter(r => {
            let as = String(r[7]).toLowerCase(), st = String(r[2]).trim(), nm = String(r[1]).toLowerCase();
            return (fN === "" || as.includes(fN)) && (fS === "" || st.toLowerCase() === fS.toLowerCase()) && (fT === "" || nm.includes(fT));
        });
        
        // üî• LOGIC S·∫ÆP X·∫æP TH√îNG MINH:
        // 1. Vi·ªác "Done" (Ho√†n th√†nh) lu√¥n n·∫±m d∆∞·ªõi c√πng.
        // 2. Vi·ªác ch∆∞a xong (Todo/Doing) n·∫±m tr√™n.
        // 3. Trong nh√≥m ch∆∞a xong: S·∫Øp x·∫øp theo Deadline TƒÇNG D·∫¶N (G·∫ßn ƒë·∫øn h·∫°n l√™n ƒë·∫ßu).
        flt.sort((a, b) => {
            const statusA = String(a[2]).trim(), statusB = String(b[2]).trim();
            const doneA = statusA === 'Done', doneB = statusB === 'Done';
            
            // N·∫øu m·ªôt c√°i xong, m·ªôt c√°i ch∆∞a -> C√°i xong ƒë·∫©y xu·ªëng d∆∞·ªõi
            if (doneA && !doneB) return 1; 
            if (!doneA && doneB) return -1;
            
            // N·∫øu c·∫£ hai c√πng tr·∫°ng th√°i (c√πng xong ho·∫∑c c√πng ch∆∞a xong) -> So s√°nh Deadline
            // C·ªôt 9 l√† gia h·∫°n, C·ªôt 4 l√† deadline g·ªëc. ∆Øu ti√™n gia h·∫°n.
            const dateA = new Date(a[9] || a[4] || '9999-12-31');
            const dateB = new Date(b[9] || b[4] || '9999-12-31');
            return dateA - dateB; // Ng√†y g·∫ßn h∆°n l√™n tr∆∞·ªõc
        });
        
        flt.forEach(r => {
            let id = r[0], name = r[1], status = String(r[2]).trim(), assignee = r[7];
            let type = r[10] || "Th∆∞·ªùng quy"; // C·ªôt 10: Ph√¢n lo·∫°i
            let group = r[11] || ""; // C·ªôt 11: T·ªï
            let dlRaw = r[9] || r[4], dlDisp = dlRaw ? new Date(dlRaw).toLocaleDateString('vi-VN') : '';
            let prog = parseProgress(r[8]);

            let isOwner = false;
            if (currentUser) { if (currentUser.role === 'Admin') isOwner = true; else if (assignee.includes(currentUser.name)) isOwner = true; }
            let disableClass = isOwner ? "" : "disabled-control";

            // Giao di·ªán
            let typeClass = type === 'C√≥ h·∫°n' ? 'type-deadline' : 'type-routine';
            let typeBadge = type === 'C√≥ h·∫°n' ? '<span class="badge bg-danger ms-1">üî• Deadline</span>' : '<span class="badge bg-secondary ms-1">Th∆∞·ªùng quy</span>';
            let groupBadge = group ? `<div class="group-tag">üè¢ ${group}</div>` : '';

            let slider = status === 'Done' 
                ? `<div class="progress" style="height:20px"><div class="progress-bar bg-success" style="width:100%">100%</div></div>` 
                : `<div class="d-flex align-items-center ${disableClass}"><input type="range" class="range-slider me-2" min="0" max="100" step="10" value="${prog}" onchange="updateProgress('${id}',this.value)"><span class="badge bg-secondary" id="val-${id}" style="min-width:35px">${prog}%</span></div>`;
            
            let badgeCls = status === 'Done' ? 'bg-done' : (status === 'Doing' ? 'bg-doing' : 'bg-todo');
            let btnDone = status !== 'Done' ? `<button class="btn btn-sm btn-outline-success mb-1 w-100 ${disableClass}" onclick="markDone('${id}')">‚úÖ Xong</button>` : '';
            let btnMail = status !== 'Done' ? `<button class="btn btn-action btn-email ${disableClass}" onclick="sendEmailBackend('${id}','${name}','${assignee}','${dlRaw}')">üìß Nh·∫Øc</button>` : '';
            
            tb.innerHTML += `
            <tr class="${typeClass}">
                <td>
                    <span class="fw-bold text-primary">${name}</span>${typeBadge}<br>
                    ${groupBadge}<br>
                    <small class="text-muted">${r[5] || ''}</small>
                </td>
                <td>${slider}</td>
                <td><small class="fw-bold">${assignee}</small></td>
                <td class="${checkOverdue(dlRaw, status)}">${dlDisp}</td>
                <td><span class="badge badge-status ${badgeCls}">${status}</span></td>
                <td>${btnDone}${btnMail}</td>
            </tr>`;
        });
    }
    
    function checkOverdue(d, s) {
        if (!d || s === 'Done') return "";
        return new Date(d) < new Date() ? "text-danger fw-bold" : "";
    }

    // --- ACTIONS ---
    function updateProgress(id, v) { if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); document.getElementById(`val-${id}`).innerText=v+'%'; fetch(SCRIPT_URL+"?action=update_progress",{method:'POST',body:JSON.stringify({id:id,progress:v, user_fullname: currentUser.name, role: currentUser.role})}).then(r=>r.json()).then(res=>{if(res.status==='error'){alert(res.message); loadTaskList();} else if(v==100)loadTaskList()}); }
    function markDone(id) { if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); if(confirm('Xong ch∆∞a?')) fetch(SCRIPT_URL+"?action=update",{method:'POST',body:JSON.stringify({id:id, user_fullname: currentUser.name, role: currentUser.role})}).then(r=>r.json()).then(res=>{alert(res.message);loadTaskList()}); }
    function parseProgress(val) { if(!val)return 0; let s=String(val).replace(/^'/,'').replace('%','').trim(); let n=parseFloat(s); return isNaN(n)?0:(n<=1&&n>0&&s.includes('.')?Math.round(n*100):Math.round(n)); }
    function loadTaskList() { document.getElementById('taskTableBody').innerHTML='<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-success"></div></td></tr>'; fetch(SCRIPT_URL).then(r=>r.json()).then(res=>{ globalData=res.data; populateFilter(); renderTable(); }); }
    function populateFilter() { const s=document.getElementById('filterAssignee'); let a=[]; globalData.forEach(r=>a.push(...String(r[7]).split(',').map(v=>v.trim()).filter(v=>v))); [...new Set(a)].sort().forEach(n=>s.innerHTML+=`<option value="${n}">${n}</option>`); }
    function sendEmailBackend(id,t,p,d){ if(!confirm(`G·ª≠i mail cho ${p}?`))return; let dl=d?new Date(d).toLocaleDateString('vi-VN'):'Som nhat'; const btn=event.target; const txt=btn.innerText; btn.innerText="‚è≥..."; btn.disabled=true; fetch(SCRIPT_URL+"?action=send_email_manual",{method:'POST',body:JSON.stringify({taskName:t,assignee:p,deadline:dl})}).then(r=>r.json()).then(res=>{alert(res.message)}).finally(()=>{btn.innerText=txt;btn.disabled=false}); }
    
    // üî• H√ÄM G·ª¨I EMAIL ƒê·ªíNG LO·∫†T
    function triggerBulkEmail() {
        if(!currentUser || currentUser.role !== 'Admin') return alert("‚õî Ch·ªâ Admin m·ªõi d√πng ƒë∆∞·ª£c t√≠nh nƒÉng n√†y!");
        
        const pendingTasks = globalData.filter(r => String(r[2]).trim() !== 'Done');
        const taskIds = pendingTasks.map(r => r[0]);
        
        if (taskIds.length === 0) return alert("Kh√¥ng c√≥ c√¥ng vi·ªác n√†o c·∫ßn g·ª≠i!");
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën g·ª≠i email nh·∫Øc nh·ªü cho ${taskIds.length} ƒë·∫ßu vi·ªác ƒëang d·ªü dang kh√¥ng?`)) return;
        
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ ƒêang g·ª≠i...";
        btn.disabled = true;

        fetch(SCRIPT_URL + "?action=send_bulk_email", {
            method: 'POST',
            body: JSON.stringify({ taskIds: taskIds, sender: currentUser.name })
        })
        .then(r => r.json())
        .then(res => alert(res.message))
        .catch(err => alert("L·ªói: " + err))
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }

    // --- FORMS ---
    document.getElementById('taskForm').addEventListener('submit', e => { 
        e.preventDefault(); 
        if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} 
        const btn=document.getElementById('submitBtn'); btn.disabled=true; 
        const d=Object.fromEntries(new FormData(e.target).entries()); 
        d.assignee=Array.from(document.getElementById('hiddenAssigneeSelect').selectedOptions).map(o=>o.value).join(', '); 
        d.role=currentUser.role; 
        fetch(SCRIPT_URL+"?action=add",{method:'POST',body:JSON.stringify(d)})
        .then(r=>r.json())
        .then(res=>{ alert(res.message); if(res.status==='success'){e.target.reset(); document.querySelectorAll('#checkboxContainer input').forEach(c=>c.checked=false); updateDisplay(document.getElementById('hiddenAssigneeSelect'),document.getElementById('selectedText'),document.getElementById('selectedCount')); document.querySelector('[data-bs-target="#pills-list"]').click(); loadTaskList();} })
        .finally(()=>{btn.disabled=false;}); 
    });
    
    document.getElementById('complianceForm').addEventListener('submit', e => { e.preventDefault(); if(!currentUser||currentUser.role!=='Admin'){alert("‚õî Ch·ªâ Admin!");return;} const btn=document.getElementById('btnCompliance'); btn.disabled=true; const d=Object.fromEntries(new FormData(e.target).entries()); d.role=currentUser.role; fetch(SCRIPT_URL+"?action=add_compliance",{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(res=>{ alert(res.message); if(res.status==='success'){e.target.reset(); loadCompliance();} }).finally(()=>{btn.disabled=false;}); });

    function initCheckboxes() { const c=document.getElementById('checkboxContainer'),h=document.getElementById('hiddenAssigneeSelect'),t=document.getElementById('selectedText'),n=document.getElementById('selectedCount'); c.innerHTML=""; let i=0; for(const[g,ppl] of Object.entries(STAFF_GROUPS)){ c.innerHTML+=`<div class="group-header">${g}</div>`; ppl.forEach(name=>{ h.add(new Option(name,name)); const d=document.createElement('div'); d.className='form-check'; d.innerHTML=`<input class="form-check-input" type="checkbox" value="${name}" id="chk${i}"><label class="form-check-label" for="chk${i}">${name}</label>`; c.appendChild(d); const ci=i; d.querySelector('input').addEventListener('change',(e)=>{h.options[ci].selected=e.target.checked; updateDisplay(h,t,n);}); i++; }); } }
    function initSingleSelect(elId) { const s=document.getElementById(elId); s.innerHTML='<option value="">-- Ch·ªçn --</option>'; for(const[g,ppl] of Object.entries(STAFF_GROUPS)){ const o=document.createElement('optgroup'); o.label=g; ppl.forEach(n=>o.innerHTML+=`<option value="${n}">${n}</option>`); s.appendChild(o); } }
    function updateDisplay(s,t,c){let cnt=0,nm=[]; Array.from(s.options).forEach(o=>{if(o.selected){cnt++;nm.push(o.value)}});c.innerText=cnt;t.innerText=cnt===0?"-- Ch·ªçn nh√¢n s·ª± --":(cnt<=2?nm.join(", "):`ƒê√£ ch·ªçn ${cnt} ng∆∞·ªùi`);}

    function loadCompliance(){const tb=document.getElementById('complianceBody');tb.innerHTML='<tr><td colspan="5" class="text-center">Loading...</td></tr>'; fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json()).then(res=>{ tb.innerHTML=""; if(!res.data||!res.data.length){tb.innerHTML='<tr><td colspan="5" class="text-center text-muted">Tr·ªëng</td></tr>';return;} res.data.reverse().forEach(r=>{ let h=r.length>=6,t=h?r[3]:(r[3].includes("Khen")?"Khen th∆∞·ªüng":"Vi ph·∫°m"),c=h?r[4]:r[3],n=h?r[5]:r[4],b=t.includes("Khen")?'<span class="badge bg-warning text-dark">üèÜ Khen</span>':'<span class="badge bg-danger">‚ö†Ô∏è Vi ph·∫°m</span>'; tb.innerHTML+=`<tr><td>${new Date(r[1]).toLocaleDateString('vi-VN')}</td><td class="fw-bold">${r[2]}</td><td>${b}</td><td>${c}</td><td>${n||''}</td></tr>`; }); }); }
    google.charts.load('current',{'packages':['corechart','bar']});
    
    function loadDashboard() { if(SCRIPT_URL.includes("D√ÅN_LINK")) return; Promise.all([fetch(SCRIPT_URL).then(r=>r.json()), fetch(SCRIPT_URL+"?action=read_compliance").then(r=>r.json())]).then(([taskRes, compRes]) => { drawCharts(taskRes.data||[], compRes.data||[]); renderCal(taskRes.data||[], compRes.data||[]); }); }
    function drawCharts(t,c) { 
        var s={'Todo':0,'Doing':0,'Done':0},p={}; t.forEach(r=>{s[String(r[2]).trim()]++; String(r[7]).split(',').forEach(n=>{n=n.trim();if(n){if(!p[n])p[n]=0;p[n]++;}});}); 
        new google.visualization.PieChart(document.getElementById('piechart_task')).draw(google.visualization.arrayToDataTable([['S','C'],['Todo',s.Todo],['Doing',s.Doing],['Done',s.Done]]),{colors:['#dc3545','#ffc107','#198754'],is3D:true,legend:'bottom',chartArea:{width:'90%',height:'80%'}}); 
        var arr=[['NV','Vi·ªác',{role:'style'}]]; Object.keys(p).sort().forEach(k=>arr.push([k,p[k],'#0d6efd'])); 
        new google.visualization.ColumnChart(document.getElementById('barchart_task')).draw(google.visualization.arrayToDataTable(arr),{legend:'none',chartArea:{width:'85%',height:'70%'}}); 
        var pc={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pc[n])pc[n]=0;if(!tp.includes("Khen"))pc[n]++;}); 
        var ac=[['NV','Vi ph·∫°m',{role:"style"}]]; Object.keys(pc).sort().forEach(k=>{if(pc[k]>0)ac.push([k,pc[k],'#dc3545']);}); 
        if(ac.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_violation')).draw(google.visualization.arrayToDataTable(ac),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_violation').innerHTML="<div class='text-center mt-5 text-muted'>Ch∆∞a c√≥ vi ph·∫°m!</div>";
        var pr={}; c.forEach(r=>{let n=r[2],h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m");if(!pr[n])pr[n]=0;if(tp.includes("Khen"))pr[n]++;}); 
        var ar=[['NV','Khen th∆∞·ªüng',{role:"style"}]]; Object.keys(pr).sort().forEach(k=>{if(pr[k]>0)ar.push([k,pr[k],'#ffc107']);}); 
        if(ar.length>1) new google.visualization.ColumnChart(document.getElementById('columnchart_reward')).draw(google.visualization.arrayToDataTable(ar),{legend:'none',chartArea:{width:'85%',height:'70%'}}); else document.getElementById('columnchart_reward').innerHTML="<div class='text-center mt-5 text-muted'>Ch∆∞a c√≥ khen th∆∞·ªüng!</div>";
    }
    
    function renderCal(t,c) { var ev=[]; t.forEach(r=>{let d=r[9]||r[4];if(!d)return;ev.push({title:`${r[1]} (${r[7]})`,start:new Date(d).toISOString().split('T')[0],color:r[2]==='Done'?'#198754':(r[2]==='Todo'?'#dc3545':'#ffc107'),textColor:r[2]==='Doing'?'black':'white',extendedProps:{description:r[5]||'Kh√¥ng c√≥ ghi ch√∫'}});}); c.forEach(r=>{if(!r[1])return;let h=r.length>=6,tp=h?r[3]:(r[3].includes("Khen")?"Khen":"Vi ph·∫°m"),ib=tp.includes("Khen"),ct=h?r[4]:r[3];ev.push({title:ib?`üèÜ ${r[2]}`:`‚ö†Ô∏è ${r[2]}`,start:new Date(r[1]).toISOString().split('T')[0],color:ib?'#fd7e14':'#212529',textColor:'white',description:ct});}); var cal=new FullCalendar.Calendar(document.getElementById('calendar'),{initialView:'dayGridMonth',locale:'vi',height:'85vh',headerToolbar:{left:'prev,next today',center:'title',right:'dayGridMonth,listMonth'},events:ev,eventClick:function(i){alert('üìå '+i.event.title+'\n‚ÑπÔ∏è '+(i.event.extendedProps.description||'Deadline'));}}); cal.render(); setTimeout(()=>cal.updateSize(),200); }
</script>
</body>
</html>
